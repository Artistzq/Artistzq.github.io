<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€3ã€‘å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ä»¥åŠåˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶</title>
    <link href="/2024/01/26/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_3_CRI/"/>
    <url>/2024/01/26/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_3_CRI/</url>
    
    <content type="html"><![CDATA[<h1 id="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€3ã€‘å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ä»¥åŠåˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶"><a href="#kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€3ã€‘å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ä»¥åŠåˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€3ã€‘å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ä»¥åŠåˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶"></a>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€3ã€‘å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ä»¥åŠåˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶</h1><h2 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h2><p>å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰æ˜¯ Kubernetesï¼ˆk8sï¼‰é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ä»æ‹‰å–å’Œè¿è¡Œå®¹å™¨é•œåƒç­‰å…³é”®ä»»åŠ¡ã€‚</p><div align=center><img src="https://92697-imgs.oss-cn-hangzhou.aliyuncs.com/blogs/20240124152148.png"></div><p>åœ¨k8s 1.23ç‰ˆæœ¬ä¹‹å‰ï¼Œkubeletä¾èµ–äºdockershimæ¥æ“ä½œDockerå®¹å™¨è¿è¡Œæ—¶ã€‚Dockerå†…éƒ¨é›†æˆäº†containerdå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºäº†æ›´åŠ ç”¨æˆ·å‹å¥½çš„åŠŸèƒ½å±‚ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€dockershiméœ€è¦éšç€Dockerçš„æ›´æ–°æŒç»­ç»´æŠ¤è·Ÿè¿›ã€‚</p><p>ä¸ºäº†å®ç°Kubernetesä¸å…·ä½“å®¹å™¨è¿è¡Œæ—¶æŠ€æœ¯çš„è§£è€¦ï¼Œè‡ªk8s 1.5ç‰ˆæœ¬èµ·ï¼Œç¤¾åŒºå¼•å…¥äº†å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆContainer Runtime Interfaceï¼ŒCRIï¼‰æ ‡å‡†ï¼Œå®ƒæä¾›äº†ä¸€ç»„æ ‡å‡†åŒ–æ¥å£ä»¥ä¾› Kubernetes å¹³å°ä¸å„ç§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ï¼Œå¹¶æ¨èä½¿ç”¨åŸç”Ÿæ”¯æŒCRIçš„å®¹å™¨è¿è¡Œæ—¶å¦‚containerdå’ŒCRI-Oã€‚è¿™ä¸€è½¬å˜æ ‡å¿—ç€Kubernetesæœªæ¥å°†ä¸å†ç›´æ¥ç»‘å®šDockerï¼Œè€Œæ˜¯é€šè¿‡å…¼å®¹CRIçš„æ ‡å‡†è¿è¡Œæ—¶ç»Ÿä¸€ç®¡æ§å®¹å™¨ï¼Œä»è€Œæé«˜äº†å®¹å™¨è¿è¡Œæ—¶çš„å¯æ’æ‹”æ€§ä»¥åŠKubernetesæœ¬èº«çš„ç¨³å®šæ€§å’Œçµæ´»æ€§ã€‚kubeleté€šè¿‡gRPCåè®®ç»“åˆprotobufåºåˆ—åŒ–æ–¹å¼æ¥å®ç°å¯¹CRIæ¥å£çš„è¿œç¨‹è°ƒç”¨è¿‡ç¨‹ã€‚</p><p>å°½ç®¡å¦‚æ­¤ï¼Œè¿™å¹¶ä¸å½±å“ç»§ç»­ä½¿ç”¨é€šè¿‡Dockeræ‰“åŒ…çš„é•œåƒã€‚å®é™…ä¸Šï¼Œä»»ä½•éµå¾ªOCIï¼ˆå¼€æ”¾å®¹å™¨å€¡è®®ï¼ŒOpen Container Initiativeï¼‰è§„èŒƒåˆ›å»ºçš„é•œåƒéƒ½å¯ä»¥è¢«å…¼å®¹ã€‚ç”±äºDockeræ‰“åŒ…çš„é•œåƒåŒæ ·éµå¾ªOCIè§„èŒƒï¼Œå› æ­¤å®ƒä»¬ä»èƒ½åœ¨k8sç¯å¢ƒä¸­å¾—åˆ°æœ‰æ•ˆçš„ç®¡ç†å’Œè¿è¡Œã€‚</p><p>CRIç›¸å…³çš„æ¦‚å¿µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://92697-imgs.oss-cn-hangzhou.aliyuncs.com/blogs/20240124144045.png" alt="cri-arch"></p><h3 id="1-1-Docker-å’Œ-dockershim"><a href="#1-1-Docker-å’Œ-dockershim" class="headerlink" title="1.1 Docker å’Œ dockershim"></a>1.1 Docker å’Œ dockershim</h3><p>Dockeræ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„å·¥å…·ï¼Œç”¨äºå¤„ç†é•œåƒæ‰“åŒ…ã€å‘å¸ƒã€å®¹å™¨è¿è¡Œç­‰æ“ä½œã€‚Dockeræœ¬èº«åŒ…å«äº†å¤šä¸ªç»„ä»¶ï¼Œå¦‚ï¼š</p><ul><li>docker-cli</li><li>containerd</li><li>runc</li><li>â€¦</li></ul><p>k8s ä¸­åŒ…å«äº†ä¸€ä¸ªç»„ä»¶ dockershimï¼Œä½¿å…¶èƒ½å¤Ÿæ”¯æŒDockerã€‚Docker æ²¡æœ‰å®ç°CRIæ¥å£ï¼ˆDockerå‡ºç°æ—¶é—´æ›´æ—©ï¼‰ï¼Œå› æ­¤ k8s ä¸å¾—ä¸è‡ªå·±ç»´æŠ¤ä¸€ä¸ªå·¥å…·ï¼Œé€šè¿‡æ­¤å·¥å…·æ“ä½œDockerï¼Œè¿™å°±æ˜¯dockershimã€‚</p><p>éšç€å®¹å™¨åŒ–æˆä¸ºè¡Œä¸šæ ‡å‡†ï¼Œk8s é¡¹ç›®ä¸ºäº†å¢åŠ äº†å¯¹é¢å¤–è¿è¡Œæ—¶çš„æ”¯æŒï¼Œæå‡ºäº† CRIï¼Œæ›´å¤šçš„è¿è¡Œæ—¶å®ç°äº†æ­¤æ¥å£ã€‚k8s é¡¹ç›®å¯¹ dockershim å’Œdockerçš„ä¾èµ–ä½¿æ•´ä¸ªé¡¹ç›®å˜å¾—è„†å¼±ï¼Œä¸”å¯¹ dockershim çš„å•ç‹¬ç»´æŠ¤å¢åŠ äº†æˆæœ¬ï¼Œåœ¨1.23ç‰ˆæœ¬åï¼Œk8s å¼€å§‹å¼ƒç”¨ dockershimï¼Œå–æ¶ˆå¯¹Dockerçš„ç›´æ¥æ”¯æŒã€‚</p><p>å¦å¤–ï¼ŒDocker çš„å¤šå±‚å°è£…å’Œè°ƒç”¨ï¼Œå¯¼è‡´å…¶åœ¨å¯ç»´æŠ¤æ€§ä¸Šç•¥é€Šä¸€ç­¹ï¼Œå¢åŠ äº†çº¿ä¸Šé—®é¢˜çš„å®šä½éš¾åº¦ã€‚</p><h3 id="1-2-CRI"><a href="#1-2-CRI" class="headerlink" title="1.2 CRI"></a>1.2 CRI</h3><p>ç±»ä¼¼ JAVA çš„ SPI æœºåˆ¶ï¼Œk8s å®šä¹‰äº† CRI åï¼Œä¸éœ€è¦å†åƒç»´æŠ¤ dockershim é‚£æ ·ï¼Œä¸ºæŸä¸ªå®¹å™¨è¿è¡Œæ—¶ç»´æŠ¤ä¸€å¥—é€‚é…å·¥å…·ã€‚åªéœ€è¦å„ä¸ªå®¹å™¨è¿è¡Œæ—¶çš„æä¾›æ–¹å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œk8s å°±å¯ä»¥ç›´æ¥è°ƒç”¨å¯¹åº”çš„æ“ä½œï¼Œä¾‹å¦‚containerdå’ŒCRI-Oã€‚</p><p>containerd æ˜¯ä¸€ä¸ªæ¥è‡ª Docker çš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶å®ç°äº† CRI è§„èŒƒã€‚å®ƒæ˜¯ä» Docker é¡¹ç›®ä¸­åˆ†ç¦»å‡ºæ¥çš„ï¼Œå› æ­¤ Docker è‡ªå·±åœ¨å†…éƒ¨ä½¿ç”¨ containerdã€‚containerd é€šè¿‡å…¶ CRI æ’ä»¶å®ç°äº† k8s å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰ï¼Œå®ƒå¯ä»¥ç®¡ç†å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ä»é•œåƒçš„ä¼ è¾“ã€å­˜å‚¨åˆ°å®¹å™¨çš„æ‰§è¡Œã€ç›‘æ§å†åˆ°ç½‘ç»œã€‚</p><p>CRI-O æ˜¯å¦ä¸€ä¸ªå®ç°äº†å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰çš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ containerd çš„ä¸€ä¸ªæ›¿ä»£å“ã€‚</p><p>ä½¿ç”¨ containerd å’Œ CRI-O çš„æ–¹æ¡ˆæ¯”èµ· docker ç®€æ´å¾ˆå¤šï¼Œå› ä¸ºçœå»äº†å†—ä½™çš„å¤šå±‚å°è£…ã€‚</p><h3 id="1-3-OCI"><a href="#1-3-OCI" class="headerlink" title="1.3 OCI"></a>1.3 OCI</h3><p>OCI æ˜¯æŒ‡å¼€æ”¾å®¹å™¨å€¡è®®ï¼ˆOpen Container Initiativeï¼‰ï¼Œæ—¨åœ¨åˆ¶å®šå®¹å™¨é•œåƒå’Œè¿è¡Œæ—¶çš„è¡Œä¸šæ ‡å‡†ã€‚åªè¦æ˜¯ç¬¦åˆè§„èŒƒçš„ä¸åŒè¿è¡Œæ—¶ï¼Œè¿™äº›è¿è¡Œæ—¶å¯ä»¥æœ‰ä¸åŒçš„åº•å±‚å®ç°ã€‚ä¾‹å¦‚ï¼Œç¬¦åˆ OCI çš„åœ¨ linux ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶å’Œåœ¨ Windows ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶ã€‚éµå¾ªè¯¥å€¡è®®çš„è¿è¡Œæ—¶é€šå¸¸æ›´åº•å±‚ï¼Œå’Œæ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œä»è€Œåˆ›å»ºå®¹å™¨ã€‚runCå’Œkata-runtimeå°±æ˜¯è¿™æ ·çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</p><p>runc æ˜¯è½»é‡çº§çš„é€šç”¨è¿è¡Œæ—¶å®¹å™¨ï¼Œå®ƒéµå®ˆ OCI è§„èŒƒï¼Œæ˜¯å®ç° OCI æ¥å£çš„æœ€ä½çº§åˆ«çš„ç»„ä»¶ï¼Œå®ƒä¸å†…æ ¸äº¤äº’åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ã€‚runc ä¸ºå®¹å™¨æä¾›äº†æ‰€æœ‰çš„ä½çº§åŠŸèƒ½ï¼Œä¸ç°æœ‰çš„ä½çº§ Linux åŠŸèƒ½äº¤äº’ï¼Œå¦‚å‘½åç©ºé—´å’Œæ§åˆ¶ç»„ï¼Œå®ƒä½¿ç”¨è¿™äº›åŠŸèƒ½æ¥åˆ›å»ºå’Œè¿è¡Œå®¹å™¨è¿›ç¨‹ã€‚</p><h3 id="1-4-dockershimçš„å¼ƒç”¨"><a href="#1-4-dockershimçš„å¼ƒç”¨" class="headerlink" title="1.4 dockershimçš„å¼ƒç”¨"></a>1.4 dockershimçš„å¼ƒç”¨</h3><p>dockershim çš„å¼ƒç”¨å¹¶ä¸æ„å‘³ç€ k8s å°†ä¸èƒ½è¿è¡Œ Docker æ ¼å¼çš„å®¹å™¨ã€‚containerd å’Œ CRI-O éƒ½å¯ä»¥è¿è¡Œ Docker æ ¼å¼çš„é•œåƒï¼Œå› ä¸º Docker æ ¼å¼çš„é•œåƒä¹Ÿéµå¾ªäº† OCI æ ¼å¼ï¼Œåªæ˜¯å®ƒä»¬ä¸å†éœ€è¦ä½¿ç”¨ docker å‘½ä»¤æˆ– Docker å®ˆæŠ¤ç¨‹åºã€‚</p><p>ä»åŠŸèƒ½æ€§æ¥è®²ï¼Œcontainerd å’Œ CRI-O éƒ½ç¬¦åˆ CRI å’Œ OCI çš„æ ‡å‡†ã€‚ä»ç¨³å®šæ€§æ¥è¯´ï¼Œcontainerd ä¸€ç›´åœ¨ docker é‡Œä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒç»éªŒæ¯”è¾ƒå……è¶³ï¼Œå› æ­¤æ›´æ¨èé€‰æ‹© containerd ä½œä¸º k8s çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</p><h2 id="2-å®éªŒ"><a href="#2-å®éªŒ" class="headerlink" title="2 å®éªŒ"></a>2 å®éªŒ</h2><p>å®éªŒç›®çš„ï¼šä½¿ç”¨ containerd æˆ– CRI-O ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶åœ¨å·¥ä½œèŠ‚ç‚¹ä¸­ä½¿ç”¨ <code>crictl</code> å‘½ä»¤ä»£æ›¿ docker å‘½ä»¤ã€‚</p><h3 id="2-1-kind-é»˜è®¤ä½¿ç”¨-containerd"><a href="#2-1-kind-é»˜è®¤ä½¿ç”¨-containerd" class="headerlink" title="2.1 kind é»˜è®¤ä½¿ç”¨ containerd"></a>2.1 kind é»˜è®¤ä½¿ç”¨ containerd</h3><p>æŸ¥é˜…æ–‡æ¡£å¾—çŸ¥ï¼ŒKind å†…éƒ¨ä½¿ç”¨ Kubeadm åˆ›å»ºå’Œå¯åŠ¨é›†ç¾¤èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥å¼ƒç”¨ dockershimå¯¹ Kind æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚å¦ä¸€ä¸ªéƒ¨ç½²å•æœºé›†ç¾¤çš„å·¥å…· <code>minikube</code> ä½¿ç”¨ cri-o ä½œä¸ºé»˜è®¤å®¹å™¨è¿è¡Œæ—¶ã€‚</p><p>è¿›å…¥Master Nodeï¼ŒæŸ¥çœ‹ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/cni-test$ docker <span class="hljs-built_in">exec</span> -it cni-test-cluster-control-plane /bin/bash<br>root@cni-test-cluster-control-plane:/<span class="hljs-comment"># kubectl get node cni-test-cluster-worker -o json | jq &#x27;.status.nodeInfo.containerRuntimeVersion&#x27;</span><br><span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>crictl</code> æŸ¥çœ‹é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@cni-test-cluster-control-plane:/<span class="hljs-comment"># crictl images ps</span><br>IMAGE                                      TAG                  IMAGE ID            SIZE<br>docker.io/flannel/flannel-cni-plugin       v1.2.0               a55d1bad692b7       3.88MB<br>docker.io/flannel/flannel                  v0.24.0              0dc86fe0f22e6       28MB<br>docker.io/kindest/kindnetd                 v20230511-dc714da8   b0b1fa0f58c6e       27.7MB<br>docker.io/kindest/local-path-helper        v20230510-486859a6   be300acfc8622       3.05MB<br>docker.io/kindest/local-path-provisioner   v20230511-dc714da8   ce18e076e9d4b       19.4MB<br>docker.io/library/go-hello-world-image     v0.0.1               586004f581b85       21.3MB<br>registry.k8s.io/coredns/coredns            v1.11.1              cbb01a7bd410d       18.2MB<br>registry.k8s.io/etcd                       3.5.10-0             a0eed15eed449       56.6MB<br>registry.k8s.io/kube-apiserver             v1.29.0              4a9136aaad730       86.1MB<br>registry.k8s.io/kube-controller-manager    v1.29.0              23d55452a141c       80.3MB<br>registry.k8s.io/kube-proxy                 v1.29.0              fa4dee78049db       83.5MB<br>registry.k8s.io/kube-scheduler             v1.29.0              ba16e783eea7b       60.6MB<br>registry.k8s.io/pause                      3.7                  221177c6082a8       311kB<br></code></pre></td></tr></table></figure><h3 id="2-2-å°†-kind-ä½¿ç”¨çš„è¿è¡Œæ—¶æ›¿æ¢æˆ-CRI-O"><a href="#2-2-å°†-kind-ä½¿ç”¨çš„è¿è¡Œæ—¶æ›¿æ¢æˆ-CRI-O" class="headerlink" title="2.2 å°† kind ä½¿ç”¨çš„è¿è¡Œæ—¶æ›¿æ¢æˆ CRI-O"></a>2.2 å°† kind ä½¿ç”¨çš„è¿è¡Œæ—¶æ›¿æ¢æˆ CRI-O</h3><p>åœ¨åˆ©ç”¨ kind å·¥å…·æ„å»ºé›†ç¾¤æ—¶ï¼Œé»˜è®¤ä¼šé‡‡ç”¨ <code>kindest/node</code> é•œåƒä½œä¸ºèŠ‚ç‚¹é•œåƒï¼Œè¯¥é•œåƒå†…éƒ¨é¢„è®¾çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯ containerdã€‚è‹¥è¦å°† containerd æ›´æ”¹ä¸º crio è¿è¡Œæ—¶ï¼Œæœ‰ä¸¤ç§å¯è¡Œæ–¹æ¡ˆï¼š</p><ol><li><p>é€šè¿‡è‡ªå®šä¹‰èŠ‚ç‚¹é•œåƒçš„æ–¹å¼è¿›è¡Œåˆ‡æ¢ï¼šé¦–å…ˆï¼Œåœ¨ <code>kindest/node</code> é•œåƒçš„åŸºç¡€ä¹‹ä¸Šé‡æ–°æ„å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹é•œåƒï¼Œå¹¶ç»“åˆä½¿ç”¨ <code>kind create cluster</code> å‘½ä»¤ä»¥åŠé€‚é… crio çš„å®šåˆ¶ç‰ˆ <code>kind-config.yaml</code> æ–‡ä»¶æ¥åˆ›å»ºæ–°çš„é›†ç¾¤ã€‚å¯ä»¥å‚è€ƒï¼š <a href="https://gist.github.com/aojea/bd1fb766302779b77b8f68fa0a81c0f2"><code>https://gist.github.com/aojea/bd1fb766302779b77b8f68fa0a81c0f2</code></a> å’Œ <a href="https://github.com/warm-metal/kindest-base-crio/tree/main"><code>https://github.com/warm-metal/kindest-base-crio/tree/main</code></a> ã€‚</p><blockquote><p>åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå‚è€ƒç½‘ç«™æä¾›çš„é•œåƒç‰ˆæœ¬è¾ƒä¸ºé™ˆæ—§ï¼Œå’Œç°æœ‰çš„ kind ä»¥åŠ k8s æœ‰å…¼å®¹æ€§é—®é¢˜ã€‚</p></blockquote></li><li><p>åœ¨å·²ç”¨ kind åˆ›å»ºå¥½çš„ k8s é›†ç¾¤ä¸Šç›´æ¥æ“ä½œï¼šè¿›å…¥ Worker èŠ‚ç‚¹æˆ– Master èŠ‚ç‚¹ï¼ˆå®ƒä»¬å®è´¨ä¸Šæ˜¯ç”± kind åˆ›å»ºçš„ Docker å®¹å™¨ï¼‰ï¼Œæ‰‹åŠ¨å®‰è£…å¹¶é…ç½® crio è¿è¡Œæ—¶ï¼Œç„¶åå¯¹èŠ‚ç‚¹è¿›è¡Œé‡æ–°åˆå§‹åŒ–æˆ–é‡æ–°åŠ å…¥é›†ç¾¤ã€‚</p><blockquote><p>ä¸ºäº†æ·±å…¥ç†è§£ k8s é›†ç¾¤åˆ›å»ºè¿‡ç¨‹ä¸­çš„å„ä¸ªç¯èŠ‚ï¼Œå¹¶å°½å¯èƒ½ä¿ç•™å…³é”®æ“ä½œæ­¥éª¤ï¼Œæˆ‘ä»¬é€‰æ‹©æ‰‹åŠ¨åœ¨é›†ç¾¤å†…å®‰è£… crio è¿è¡Œæ—¶ã€‚åç»­çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•æ¢ç´¢å¦‚ä½•æ‰“åŒ…é€‚é… crio çš„èŠ‚ç‚¹é•œåƒã€‚</p></blockquote></li></ol><p>æœ¬ç¯‡æ–‡ç« é‡ç‚¹å…³æ³¨ç¬¬2ç§æ–¹æ³•ã€‚</p><h4 id="2-2-1-åˆ›å»ºæ–°é›†ç¾¤"><a href="#2-2-1-åˆ›å»ºæ–°é›†ç¾¤" class="headerlink" title="2.2.1 åˆ›å»ºæ–°é›†ç¾¤"></a>2.2.1 åˆ›å»ºæ–°é›†ç¾¤</h4><p>åˆ©ç”¨æœ¬ç³»åˆ—ç¬¬ä¸€ç¯‡åšå®¢çš„é…ç½®æ–‡ä»¶ <a href="https://github.com/Artistzq/kubelabs/tree/main/hello"><code>https://github.com/Artistzq/kubelabs/tree/main/hello</code></a> ï¼Œé‡æ–°åˆ›å»ºé›†ç¾¤ <code>crio-hello-cluster</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash create.sh -n crio-hello-cluster<br></code></pre></td></tr></table></figure><p>è¿›å…¥ Master èŠ‚ç‚¹ <code>crio-hello-cluster-control-plane</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it crio-hello-cluster-control-plane /bin/bash<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¿¡æ¯</p><ul><li><p>æŸ¥çœ‹ k8s ç‰ˆæœ¬</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@hello-crio-cluster-control-plane:/<span class="hljs-comment"># kubectl version</span><br>Client Version: v1.29.0<br>Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3<br>Server Version: v1.29.0<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ linux å‘è¡Œç‰ˆæœ¬</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@crio-hello-cluster-control-plane:/<span class="hljs-comment"># cat /etc/issue</span><br>Debian GNU/Linux 11 \n \l<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@crio-hello-cluster-control-plane:/<span class="hljs-comment"># kubectl get nodes -owide</span><br>NAME                               STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME<br>crio-hello-cluster-control-plane   Ready    control-plane   34m   v1.29.0   172.18.0.6    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br>crio-hello-cluster-worker          Ready    &lt;none&gt;          34m   v1.29.0   172.18.0.7    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br>crio-hello-cluster-worker2         Ready    &lt;none&gt;          34m   v1.29.0   172.18.0.5    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¶ï¼Œéƒ½æ˜¯ <code>containerd://1.7.1</code>ã€‚</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@crio-hello-cluster-control-plane:/<span class="hljs-comment"># kubectl get nodes -o json | jq -r &#x27;.items[] | &#123;Name: .metadata.name, ContainerRuntime: .status.nodeInfo.containerRuntimeVersion&#125;&#x27;</span><br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-control-plane&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br>&#125;<br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-worker&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br>&#125;<br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-worker2&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="2-2-2-ä¸º-WorkerNode-å®‰è£…CRIO"><a href="#2-2-2-ä¸º-WorkerNode-å®‰è£…CRIO" class="headerlink" title="2.2.2 ä¸º WorkerNode å®‰è£…CRIO"></a>2.2.2 ä¸º WorkerNode å®‰è£…CRIO</h4><p><code>kind-config.yaml</code> é…ç½®æ–‡ä»¶æŒ‡å®šäº†1ä¸ª MasterNode å’Œ2ä¸ª WorkerNodeï¼Œæˆ‘ä»¬è¿›å…¥å…¶ä¸­ä¸€ä¸ªWorkerNodeï¼ŒæŒ‰ç…§å®˜ç½‘ <a href="https://cri-o.io/"><code>https://cri-o.io/</code></a> å’Œ Github å®˜æ–¹ä»“åº“ <a href="https://github.com/cri-o/cri-o/blob/main/install.md"><code>https://github.com/cri-o/cri-o/blob/main/install.md</code></a> ä¸Šçš„æŒ‡å¯¼ï¼Œä¸ºå…¶å®‰è£… CRIO-Oã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it crio-hello-cluster-worker /bin/bash<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šä»¥ä¸‹çš„å®‰è£… CRI-O çš„æ“ä½œéƒ½æ˜¯åœ¨æ­¤èŠ‚ç‚¹å®¹å™¨å†…è¿›è¡Œçš„ï¼</p></blockquote><ol><li><p>æŒ‡å®š <code>VERSION</code> å’Œ <code>OS</code> ç¯å¢ƒå˜é‡ã€‚  </p><p> OSæŒ‡å®šå½“å‰ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼Œå®˜ç½‘ç»™å‡ºäº†å¯¹åº”å…³ç³»ï¼Œä¾‹å¦‚Ubuntu 20.04çš„ä¸»æœºï¼Œéœ€è¦ <code>export OS=xUbuntu_20.04</code> ã€‚ kind åˆ›å»ºçš„èŠ‚ç‚¹ä¸ºDebian 11ï¼Œå¯¹åº” <code>export OS=Debian_11</code>ã€‚</p><p> VERSIONæŒ‡å®šcrioçš„ç‰ˆæœ¬ï¼Œæ”¯æŒä¸»ç‰ˆæœ¬å’Œå…·ä½“ç‰ˆæœ¬çš„æŒ‡å®šï¼Œä¾‹å¦‚ <code>1.24:1.24.1</code> ã€‚è¿™é‡Œæœ‰å‘ï¼š**<code>opensuse</code> ä¸Šæ”¯æŒçš„æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ <code>1.24.6</code>** ï¼Œæ›´é«˜çš„ç‰ˆæœ¬å¦‚ github ä¸Šçš„æœ€æ–°ç‰ˆ <code>1.29.1</code> ï¼Œæ˜¯æ— æ³•åœ¨ <a href="https://download.opensuse.org/repositories"><code>https://download.opensuse.org/repositories</code></a> ä¸­ä¸‹è½½çš„ï¼Œè€Œæ–‡æ¡£æ²¡æœ‰è¯´æ˜è¿™ä¸€ç‚¹ï¼Œåªè¯´æ˜äº†æ”¯æŒä¸»ç‰ˆæœ¬å·å’Œå…·ä½“ç‰ˆæœ¬å·ã€‚å› æ­¤å®‰è£…æ—¶ï¼Œå¦‚æœæŒ‡å®šç‰ˆæœ¬ä¸º <code>1.29.1</code> ï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºæ— æ³•æ‰¾åˆ°æ–‡ä»¶ã€‚</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> OS=Debian_11<br><span class="hljs-built_in">export</span> VERSION=1.24.6<br><span class="hljs-built_in">export</span> SUBVERSION=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span> | awk -F<span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-string">&#x27;&#123;print $1&quot;.&quot;$2&#125;&#x27;</span>) <span class="hljs-comment"># 1.24</span><br></code></pre></td></tr></table></figure></li><li><p>å®‰è£…ç›¸å…³å·¥å…·</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-get install -y gnupg tzdata<br></code></pre></td></tr></table></figure></li><li><p>æ·»åŠ  apt æºï¼Œå¹¶ä¸‹è½½å®‰è£… crio</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONTAINERS_URL=<span class="hljs-string">&quot;https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/<span class="hljs-variable">$&#123;OS&#125;</span>/&quot;</span><br><span class="hljs-comment"># crio é•œåƒåœ°å€</span><br>CRIO_URL=<span class="hljs-string">&quot;http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/<span class="hljs-variable">$&#123;SUBVERSION&#125;</span>:/<span class="hljs-variable">$&#123;VERSION&#125;</span>/<span class="hljs-variable">$&#123;OS&#125;</span>/&quot;</span><br><br><span class="hljs-comment"># æŠŠä¸Šè¿° url æ·»åŠ åˆ° apt çš„æº</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb <span class="hljs-variable">$&#123;CONTAINERS_URL&#125;</span> /&quot;</span> &gt; /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb <span class="hljs-variable">$&#123;CRIO_URL&#125;</span> /&quot;</span> &gt; /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:<span class="hljs-variable">$&#123;VERSION&#125;</span>.list<br><br><span class="hljs-comment"># ä¸‹è½½å¯†é’¥ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° apt ä¿¡ä»»å¯†é’¥åˆ—è¡¨</span><br>curl -L <span class="hljs-variable">$&#123;CONTAINERS_URL&#125;</span>Release.key | apt-key add - || <span class="hljs-literal">true</span><br>curl -L <span class="hljs-variable">$&#123;CRIO_URL&#125;</span>Release.key | apt-key add - || <span class="hljs-literal">true</span><br><br><span class="hljs-comment"># é€šè¿‡ apt å®‰è£… cri-o å’Œ cri-o-runc</span><br>apt-get update<br>apt-get install -y cri-o cri-o-runc<br></code></pre></td></tr></table></figure><p> å¦‚æœä¸‹è½½å¤ªæ…¢å¯ä»¥ä¸´æ—¶æ·»åŠ ä»£ç†ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> http_proxy=<span class="hljs-string">&quot;http:192.168.115.1:7890&quot;</span><br><span class="hljs-built_in">export</span> https_proxy=<span class="hljs-string">&quot;http:192.168.115.1:7890&quot;</span><br><span class="hljs-built_in">env</span> | grep proxy <span class="hljs-comment"># æ£€æŸ¥</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šåœ¨åç»­è¦å–æ¶ˆ <code>proxy</code> ç›¸å…³ç¯å¢ƒå˜é‡ï¼Œæˆ–åŠ å…¥ <code>no_proxy</code> çš„å˜é‡ï¼Œå¦åˆ™å¯¼è‡´æ­¤å·¥ä½œèŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ã€‚</p></blockquote><p> å®‰è£…ç»“æŸæ—¶ä¼šæç¤º <code>crictl.yaml</code> å·²å­˜åœ¨ï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹ä¹‹å‰ä½¿ç”¨çš„æ˜¯ <code>containerd</code> ï¼Œå·²ç»é…ç½®äº† <code>crictl</code> ã€‚è¿™é‡Œé€‰æ‹©è¦†ç›– <code>Y</code> ã€‚</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">Configuration file <span class="hljs-string">&#x27;/etc/crictl.yaml&#x27;</span><br>==&gt; File on system created by you or by a script.<br>==&gt; File also <span class="hljs-keyword">in</span> package provided by package maintainer.<br>What would you like to <span class="hljs-keyword">do</span> about it ?  Your options are:<br>    Y or I  : install the package maintainer<span class="hljs-string">&#x27;s version</span><br><span class="hljs-string">    N or O  : keep your currently-installed version</span><br><span class="hljs-string">    D     : show the differences between the versions</span><br><span class="hljs-string">    Z     : start a shell to examine the situation</span><br><span class="hljs-string">The default action is to keep your current version.</span><br><span class="hljs-string">*** crictl.yaml (Y/I/N/O/D/Z) [default=N] ? Y</span><br></code></pre></td></tr></table></figure></li><li><p>é…ç½® cri-o</p><p> å®‰è£…å®Œåé…ç½® <code>cri-o</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;[crio.runtime]</span><br><span class="hljs-string">cgroup_manager=\&quot;cgroupfs\&quot;</span><br><span class="hljs-string">conmon_cgroup=\&quot;pod\&quot;</span><br><span class="hljs-string">pause_image = \&quot;k8s.gcr.io/pause:3.2\&quot;</span><br><span class="hljs-string">storage_driver = \&quot;vfs\&quot;&quot;</span> &gt; /etc/crio/crio.conf<br><br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½® crictl</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å°† crictl.yaml ä¸­æ‰€æœ‰å‡ºç°çš„ containerd å­—ç¬¦ä¸²æ›¿æ¢ä¸º crio</span><br>sed -i <span class="hljs-string">&#x27;s/containerd/crio/g&#x27;</span> /etc/crictl.yaml<br></code></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥ containerd å’Œ crio</p><p> æ£€æŸ¥å½“å‰çŠ¶æ€</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># containerd çŠ¶æ€</span><br>$ systemctl status containerd | grep Active <span class="hljs-comment"># Runing</span><br> Active: active (running) since Fri 2024-01-26 08:23:49 UTC; 1h 8min ago<br><span class="hljs-comment"># crio çŠ¶æ€</span><br>$ systemctl status crio | grep Active <span class="hljs-comment"># Dead</span><br> Active: inactive (dead)<br></code></pre></td></tr></table></figure><p> å…³é—­ <code>containerd</code> æœåŠ¡ï¼Œå¯åŠ¨ <code>crio</code> æœåŠ¡</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ systemctl <span class="hljs-built_in">disable</span> containerd &amp;&amp; systemctl stop containerd<br>Removed /etc/systemd/system/multi-user.target.wants/containerd.service.<br>$ systemctl <span class="hljs-built_in">enable</span> crio &amp;&amp; systemctl start crio<br></code></pre></td></tr></table></figure><p> å†æ¬¡æ£€æŸ¥çŠ¶æ€</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ systemctl status containerd | grep Active <span class="hljs-comment"># Dead</span><br> Active: inactive (dead) since Fri 2024-01-26 09:36:03 UTC; 50s ago<br>$ systemctl status crio | grep Active <span class="hljs-comment"># Runing</span><br> Active: active (running) since Fri 2024-01-26 09:35:08 UTC; 1min 50s ago<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-2-3-ä½¿ç”¨-Kubeadm-é‡æ–°åŠ å…¥é›†ç¾¤"><a href="#2-2-3-ä½¿ç”¨-Kubeadm-é‡æ–°åŠ å…¥é›†ç¾¤" class="headerlink" title="2.2.3 ä½¿ç”¨ Kubeadm é‡æ–°åŠ å…¥é›†ç¾¤"></a>2.2.3 ä½¿ç”¨ <code>Kubeadm</code> é‡æ–°åŠ å…¥é›†ç¾¤</h4><ol><li><p>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</p><p> é‡æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¿›å…¥ MasterNodeï¼Œæ£€æŸ¥é›†ç¾¤çŠ¶æ€</p><blockquote><p>æ­¤å‘½ä»¤åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ</p></blockquote> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker <span class="hljs-built_in">exec</span> -it crio-hello-cluster-control-plane kubectl get nodes -owide<br>NAME                               STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME<br>crio-hello-cluster-control-plane   Ready      control-plane   77m   v1.29.0   172.18.0.6    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br>crio-hello-cluster-worker          NotReady   &lt;none&gt;          76m   v1.29.0   172.18.0.7    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://Unknown<br>crio-hello-cluster-worker2         Ready      &lt;none&gt;          76m   v1.29.0   172.18.0.5    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br></code></pre></td></tr></table></figure><p> è§‚å¯Ÿåˆ°å‰é¢æ“ä½œçš„èŠ‚ç‚¹ <code>crio-hello-cluster-worker</code> å·²ç»è¿›å…¥ <code>NotReady</code> çŠ¶æ€ï¼ŒCONTAINER-RUNTIME ä¸º <code>containerd://Unknown</code> ã€‚</p></li><li><p>ä½¿ç”¨ <code>kubeadm join</code> å°†èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</p><p> æ­¤æ—¶ï¼Œä¸ºäº†å°†å·¥ä½œèŠ‚ç‚¹é‡æ–°åŠ å…¥æ­¤é›†ç¾¤ï¼Œéœ€è¦å…ˆåœ¨MasterNodeä¸Šç”Ÿæˆtokenï¼š</p><blockquote><p>æ­¤å‘½ä»¤åœ¨MasterNodeä¸­æ‰§è¡Œã€‚è®°å¾—å…³é—­ä»£ç†ï¼Œå¦åˆ™æ— æ³•åŠ å…¥ã€‚å¯ä»¥ <code>unset http_proxy &amp;&amp; unset https_proxy</code>ã€‚å¦‚æœæ·»åŠ ç¯å¢ƒå˜é‡ <code>export no_proxy=&quot;localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12&quot;</code> ï¼Œæµ‹è¯•å³ä½¿é‡å¯ä¹Ÿæ— æ•ˆã€‚</p></blockquote> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubeadm token create --print-join-command<br>kubeadm <span class="hljs-built_in">join</span> crio-hello-cluster-control-plane:6443 --token xeogi6.plnsolw9cd8457mc --discovery-token-ca-cert-hash sha256:0f84c44d447641f23345cd8269a27645fe149d19028a6afe6a07f0b7aac191c5 <br></code></pre></td></tr></table></figure><p> ä½†åœ¨ WorkerNodeä¸Šæ‰§è¡Œè¿”å›çš„å‘½ä»¤ï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºé¢„æ£€é”™è¯¯ï¼Œè¡¨æ˜kubeletåœ¨æ‰§è¡Œç³»ç»ŸéªŒè¯æ—¶å°è¯•åŠ è½½åä¸ºâ€œconfigsâ€çš„å†…æ ¸æ¨¡å—ä»¥è§£æå†…æ ¸é…ç½®ï¼Œä½†æœªèƒ½åœ¨ <code>/lib/modules/5.15.0-92-generic</code> ç›®å½•ä¸‹æ‰¾åˆ°è¯¥æ¨¡å—ã€‚</p><blockquote><p>ä»¥ä¸‹å‘½ä»¤åœ¨WorkerNode <code>crio-hello-cluster-worker</code>ä¸Šæ‰§è¡Œ</p></blockquote> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@hello-crio-worker:/home<span class="hljs-comment"># kubeadm join crio-hello-cluster-control-plane:6443 --token xeogi6.plnsolw9cd8457mc --discovery-token-ca-cert-hash sha256:0f84c44d447641f23345cd8269a27645fe149d19028a6afe6a07f0b7aac191c5 </span><br>[preflight] Running pre-flight checks<br>    [WARNING Swap]: swap is supported <span class="hljs-keyword">for</span> cgroup v2 only; the NodeSwap feature gate of the kubelet is beta but disabled by default<br>    [WARNING FileExisting-socat]: socat not found <span class="hljs-keyword">in</span> system path<br>[preflight] The system verification failed. Printing the output from the verification:<br>...<br>error execution phase preflight: [preflight] Some fatal errors occurred:<br>    [ERROR SystemVerification]: failed to parse kernel config: unable to load kernel module: <span class="hljs-string">&quot;configs&quot;</span>, output: <span class="hljs-string">&quot;modprobe: FATAL: Module configs not found in directory /lib/modules/5.15.0-92-generic\n&quot;</span>, err: <span class="hljs-built_in">exit</span> status 1<br>[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`<br>To see the stack trace of this error execute with --v=5 or higher<br></code></pre></td></tr></table></figure><p> æš‚æ—¶æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š</p><ul><li>å¿½ç•¥é—®é¢˜ã€‚<a href="https://github.com/kubernetes/kubernetes/issues/41025"><code>https://github.com/kubernetes/kubernetes/issues/41025</code></a></li><li>å‡çº§å†…æ ¸é•œåƒã€é…ç½®å®¹å™¨ã€‚<a href="https://stackoverflow.com/questions/54128045/errors-while-creating-master-in-cluster-of-kubernetes-in-lxc-container"><code>https://stackoverflow.com/questions/54128045/errors-while-creating-master-in-cluster-of-kubernetes-in-lxc-container</code></a></li></ul><p> ç›®å‰é‡‡ç”¨çš„æ˜¯å¿½ç•¥é—®é¢˜ï¼Œæš‚æ—¶æ— æ³•åˆ¤æ–­ä½¿ç”¨æ­¤é€‰é¡¹çš„åç»­é—®é¢˜ã€‚åŠ ä¸Šå¿½ç•¥é”™è¯¯ï¼ŒèŠ‚ç‚¹æ·»åŠ æˆåŠŸï¼</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubeadm <span class="hljs-built_in">join</span> crio-hello-cluster-control-plane:6443 --token xeogi6.plnsolw9cd8457mc --discovery-token-ca-cert-hash sha256:0f84c44d447641f23345cd8269a27645fe149d19028a6afe6a07f0b7aac191c5 --ignore-preflight-errors=SystemVerification<br><br>[preflight] Running pre-flight checks<br>    [WARNING Swap]: swap is supported <span class="hljs-keyword">for</span> cgroup v2 only; the NodeSwap feature gate of the kubelet is beta but disabled by default<br>    [WARNING FileExisting-socat]: socat not found <span class="hljs-keyword">in</span> system path<br>[preflight] The system verification failed. Printing the output from the verification:<br>KERNEL_VERSION: 5.15.0-92-generic<br>OS: Linux<br>...<br>    [WARNING SystemVerification]: failed to parse kernel config: unable to load kernel module: <span class="hljs-string">&quot;configs&quot;</span>, output: <span class="hljs-string">&quot;modprobe: FATAL: Module configs not found in directory /lib/modules/5.15.0-92-generic\n&quot;</span>, err: <span class="hljs-built_in">exit</span> status 1<br>[preflight] Reading configuration from the cluster...<br>[preflight] FYI: You can look at this config file with <span class="hljs-string">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span><br>[kubelet-start] Writing kubelet configuration to file <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br>[kubelet-start] Writing kubelet environment file with flags to file <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br>[kubelet-start] Starting the kubelet<br>[kubelet-start] Waiting <span class="hljs-keyword">for</span> the kubelet to perform the TLS Bootstrap...<br><br>This node has joined the cluster:<br>* Certificate signing request was sent to apiserver and a response was received.<br>* The Kubelet was informed of the new secure connection details.<br><br>Run <span class="hljs-string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="hljs-built_in">join</span> the cluster.<br></code></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥é›†ç¾¤çŠ¶æ€</p><p> ä»å®¿ä¸»æœºè¿›å…¥MasterNode</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu$ docker <span class="hljs-built_in">exec</span> -it crio-hello-cluster-control-plane /bin/bash<br></code></pre></td></tr></table></figure><blockquote><p>ä»¥ä¸‹å‘½ä»¤åœ¨ <code>crio-hello-cluster-control-plane</code> ä¸­æ‰§è¡Œ</p></blockquote><p> æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼ŒèŠ‚ç‚¹ <code>crio-hello-cluster-worker</code> å·²å¤„äº <code>Ready</code> çŠ¶æ€ï¼Œå®¹å™¨è¿è¡Œæ—¶å·²åˆ‡æ¢ä¸º <code>cri-o://1.24.6</code> ã€‚</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get nodes -owide<br>NAME                               STATUS   ROLES           AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME<br>crio-hello-cluster-control-plane   Ready    control-plane   106m   v1.29.0   172.18.0.6    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br>crio-hello-cluster-worker          Ready    &lt;none&gt;          11s    v1.29.0   172.18.0.7    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   cri-o://1.24.6<br>crio-hello-cluster-worker2         Ready    &lt;none&gt;          106m   v1.29.0   172.18.0.5    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-92-generic   containerd://1.7.1<br></code></pre></td></tr></table></figure> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get nodes -o json | jq -r <span class="hljs-string">&#x27;.items[] | &#123;Name: .metadata.name, ContainerRuntime: .status.nodeInfo.containerRuntimeVersion&#125;&#x27;</span><br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-control-plane&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br>&#125;<br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-worker&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;cri-o://1.24.6&quot;</span><br>&#125;<br>&#123;<br><span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;crio-hello-cluster-worker2&quot;</span>,<br><span class="hljs-string">&quot;ContainerRuntime&quot;</span>: <span class="hljs-string">&quot;containerd://1.7.1&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="2-3-è‡ªå·±æ„å»º-kind-node-é•œåƒ"><a href="#2-3-è‡ªå·±æ„å»º-kind-node-é•œåƒ" class="headerlink" title="2.3 è‡ªå·±æ„å»º kind node é•œåƒ"></a>2.3 è‡ªå·±æ„å»º <code>kind node</code> é•œåƒ</h3><p>åç»­æ–‡ç« å°è¯•</p><hr><h2 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h2><h3 id="ä»¥å‰çš„é…ç½®æ— æ³•åˆ›å»ºé›†ç¾¤"><a href="#ä»¥å‰çš„é…ç½®æ— æ³•åˆ›å»ºé›†ç¾¤" class="headerlink" title="ä»¥å‰çš„é…ç½®æ— æ³•åˆ›å»ºé›†ç¾¤"></a>ä»¥å‰çš„é…ç½®æ— æ³•åˆ›å»ºé›†ç¾¤</h3><p>ä¸­é€”çªç„¶æ— æ³•å¯åŠ¨kubeletï¼Œä»»ä½•å¤šèŠ‚ç‚¹çš„é›†ç¾¤éƒ½æ— æ³•åˆ›å»ºï¼Œå³ä½¿ä½¿ç”¨å‰é¢åšå®¢æ–‡ç« çš„é…ç½®æ–‡ä»¶ä¹Ÿæ— æ³•åˆ›å»ºé›†ç¾¤ï¼Œæç¤ºkubeletæ— æ³•å¯åŠ¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ bash create.sh -name <span class="hljs-built_in">test</span><br>cluster-name: ame<br>Creating cluster <span class="hljs-string">&quot;ame&quot;</span> ...<br> âœ“ Ensuring node image (kindest/node:v1.29.0) ğŸ–¼<br> âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦  <br> âœ“ Writing configuration ğŸ“œ <br> âœ— Starting control-plane ğŸ•¹ï¸ <br>Deleted nodes: [<span class="hljs-string">&quot;ame-worker&quot;</span> <span class="hljs-string">&quot;ame-worker2&quot;</span> <span class="hljs-string">&quot;ame-control-plane&quot;</span>]<br>ERROR: failed to create cluster: failed to init node with kubeadm: <span class="hljs-built_in">command</span> <span class="hljs-string">&quot;docker exec --privileged ame-control-plane kubeadm init --skip-phases=preflight --config=/kind/kubeadm.conf --skip-token-print --v=6&quot;</span> failed with error: <span class="hljs-built_in">exit</span> status 1<br>Command Output: I0125 11:40:19.477864     172 initconfiguration.go:260] loading configuration from <span class="hljs-string">&quot;/kind/kubeadm.conf&quot;</span><br>Â·Â·Â·<br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-apiserver&quot;</span><br>I0125 11:40:24.816401     172 local.go:65] [etcd] wrote Static Pod manifest <span class="hljs-keyword">for</span> a <span class="hljs-built_in">local</span> etcd member to <span class="hljs-string">&quot;/etc/kubernetes/manifests/etcd.yaml&quot;</span><br>Â·Â·Â·<br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-controller-manager&quot;</span><br>I0125 11:40:24.820970     172 manifests.go:157] [control-plane] wrote static Pod manifest <span class="hljs-keyword">for</span> component <span class="hljs-string">&quot;kube-controller-manager&quot;</span> to <span class="hljs-string">&quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot;</span><br>I0125 11:40:24.821181     172 manifests.go:102] [control-plane] getting StaticPodSpecs<br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-scheduler&quot;</span><br>I0125 11:40:24.821653     172 manifests.go:128] [control-plane] adding volume <span class="hljs-string">&quot;kubeconfig&quot;</span> <span class="hljs-keyword">for</span> component <span class="hljs-string">&quot;kube-scheduler&quot;</span><br>I0125 11:40:24.822478     172 manifests.go:157] [control-plane] wrote static Pod manifest <span class="hljs-keyword">for</span> component <span class="hljs-string">&quot;kube-scheduler&quot;</span> to <span class="hljs-string">&quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot;</span><br>I0125 11:40:24.822522     172 kubelet.go:68] Stopping the kubelet<br>[kubelet-start] Writing kubelet environment file with flags to file <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br>[kubelet-start] Writing kubelet configuration to file <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br>[kubelet-start] Starting the kubelet<br>I0125 11:40:24.982554     172 waitcontrolplane.go:83] [wait-control-plane] Waiting <span class="hljs-keyword">for</span> the API server to be healthy<br>I0125 11:40:24.983290     172 loader.go:395] Config loaded from file:  /etc/kubernetes/admin.conf<br>[wait-control-plane] Waiting <span class="hljs-keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s<br>I0125 11:40:24.985303     172 round_trippers.go:553] GET https://ame-control-plane:6443/healthz?<span class="hljs-built_in">timeout</span>=10s  <span class="hljs-keyword">in</span> 0 milliseconds<br>Â·Â·Â·<br>[kubelet-check] Initial <span class="hljs-built_in">timeout</span> of 40s passed.<br>I0125 11:41:04.986148     172 round_trippers.go:553] GET https://ame-control-plane:6443/healthz?<span class="hljs-built_in">timeout</span>=10s  <span class="hljs-keyword">in</span> 0 milliseconds<br>[kubelet-check] It seems like the kubelet isn<span class="hljs-string">&#x27;t running or healthy.</span><br><span class="hljs-string">[kubelet-check] The HTTP call equal to &#x27;</span>curl -sSL http://localhost:10248/healthz<span class="hljs-string">&#x27; failed with error: Get &quot;http://localhost:10248/healthz&quot;: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="hljs-string">I0125 11:41:05.487445     172 round_trippers.go:553] GET https://ame-control-plane:6443/healthz?timeout=10s  in 0 milliseconds</span><br><span class="hljs-string">Â·Â·Â·</span><br><span class="hljs-string">[kubelet-check] It seems like the kubelet isn&#x27;</span>t running or healthy.<br>[kubelet-check] The HTTP call equal to <span class="hljs-string">&#x27;curl -sSL http://localhost:10248/healthz&#x27;</span> failed with error: Get <span class="hljs-string">&quot;http://localhost:10248/healthz&quot;</span>: dial tcp [::1]:10248: connect: connection refused.<br>I0125 11:41:10.486636     172 round_trippers.go:553] GET https://ame-control-plane:6443/healthz?<span class="hljs-built_in">timeout</span>=10s  <span class="hljs-keyword">in</span> 0 milliseconds<br>Â·Â·Â·<br>[kubelet-check] It seems like the kubelet isn<span class="hljs-string">&#x27;t running or healthy.</span><br><span class="hljs-string">[kubelet-check] The HTTP call equal to &#x27;</span>curl -sSL http://localhost:10248/healthz<span class="hljs-string">&#x27; failed with error: Get &quot;http://localhost:10248/healthz&quot;: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="hljs-string">I0125 11:41:20.486427     172 round_trippers.go:553] GET https://ame-control-plane:6443/healthz?timeout=10s  in 0 milliseconds</span><br><span class="hljs-string">Â·Â·Â·</span><br><span class="hljs-string">couldn&#x27;</span>t initialize a Kubernetes cluster<br>[kubelet-check] It seems like the kubelet isn<span class="hljs-string">&#x27;t running or healthy.</span><br><span class="hljs-string">[kubelet-check] The HTTP call equal to &#x27;</span>curl -sSL http://localhost:10248/healthz<span class="hljs-string">&#x27; failed with error: Get &quot;http://localhost:10248/healthz&quot;: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Unfortunately, an error has occurred:</span><br><span class="hljs-string">timed out waiting for the condition</span><br><span class="hljs-string"></span><br><span class="hljs-string">This error is likely caused by:</span><br><span class="hljs-string">- The kubelet is not running</span><br><span class="hljs-string">- The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)</span><br><span class="hljs-string">Â·Â·Â·</span><br></code></pre></td></tr></table></figure><p>å…ˆåæ£€æŸ¥äº†èŠ‚ç‚¹çš„ <code>kubelet status</code>ã€ <code>api-server</code>ã€ <code>container runtime</code> ç­‰ï¼Œæ— é—®é¢˜ï¼Œæœ€åå‚è€ƒ <a href="https://github.com/kubernetes-sigs/kind/issues/2702"><code>https://github.com/kubernetes-sigs/kind/issues/2702</code></a> ï¼Œå¯èƒ½æ˜¯èµ„æºå ç”¨å¤ªå¤§ï¼Œå› æ­¤åˆ é™¤äº†ä¹‹å‰çš„é›†ç¾¤ï¼Œé‡æ–°å»ºç«‹ï¼Œé”™è¯¯è§£å†³ã€‚</p><h3 id="ä½¿ç”¨-kind-crio-é•œåƒæ— æ³•åˆ›å»ºé›†ç¾¤"><a href="#ä½¿ç”¨-kind-crio-é•œåƒæ— æ³•åˆ›å»ºé›†ç¾¤" class="headerlink" title="ä½¿ç”¨ kind-crio é•œåƒæ— æ³•åˆ›å»ºé›†ç¾¤"></a>ä½¿ç”¨ kind-crio é•œåƒæ— æ³•åˆ›å»ºé›†ç¾¤</h3><p>ä½¿ç”¨ <a href="https://github.com/warm-metal/kindest-base-crio/tree/main"><code>https://github.com/warm-metal/kindest-base-crio/tree/main</code></a> æä¾›çš„é•œåƒï¼Œä¾ç„¶æç¤º kubelet æ— æ³•è¿æ¥ï¼Œé”™è¯¯åŒä¸Šã€‚</p><p>æŸ¥é˜…<a href="https://hub.docker.com/r/warmmetal/kindest-node-crio"><code>https://hub.docker.com/r/warmmetal/kindest-node-crio</code></a>ï¼Œè¯¥é•œåƒæœ€è¿‘ä¸€ä¸ªæœˆæ›´æ–°è¿‡ï¼Œä½†å³ä½¿ä½¿ç”¨æœ€æ–°çš„ä¹Ÿæ— æ³•åˆ›å»ºé›†ç¾¤ã€‚ <a href="https://gist.github.com/aojea/bd1fb766302779b77b8f68fa0a81c0f2"><code>https://gist.github.com/aojea/bd1fb766302779b77b8f68fa0a81c0f2</code></a> æåˆ°å¯èƒ½æ˜¯ kind å’Œ k8s æ›´æ–°å¤ªå¿«ï¼Œå…¼å®¹æ€§è¢«æ‰“ç ´ï¼Œå› æ­¤æœ¬å®éªŒæŠ›å¼ƒäº†ä½¿ç”¨è¯¥ä»“åº“çš„é•œåƒ <code>kindest-base-crio</code> çš„æ–¹æ¡ˆã€‚</p>]]></content>
    
    
    <categories>
      
      <category>kubelabs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
      <tag>cri</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€2ã€‘å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰ä»¥åŠåˆ‡æ¢CNIæ’ä»¶</title>
    <link href="/2024/01/14/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_2_CNI/"/>
    <url>/2024/01/14/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_2_CNI/</url>
    
    <content type="html"><![CDATA[<h1 id="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€2ã€‘å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰ä»¥åŠåˆ‡æ¢CNIæ’ä»¶"><a href="#kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€2ã€‘å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰ä»¥åŠåˆ‡æ¢CNIæ’ä»¶" class="headerlink" title="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€2ã€‘å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰ä»¥åŠåˆ‡æ¢CNIæ’ä»¶"></a>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€2ã€‘å®¹å™¨ç½‘ç»œæ¥å£ï¼ˆCNIï¼‰ä»¥åŠåˆ‡æ¢CNIæ’ä»¶</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p><code>Container Network Interfaceï¼ˆCNIï¼‰</code>ï¼Œå³å®¹å™¨ç½‘ç»œæ¥å£ï¼Œæ˜¯ä¸€ç§æ ‡å‡†åŒ–çš„APIè§„èŒƒï¼Œæ—¨åœ¨ä¸ºå®¹å™¨æä¾›ä¸€è‡´ä¸”çµæ´»çš„ç½‘ç»œé…ç½®æ–¹æ¡ˆã€‚åœ¨Kubernetesç¯å¢ƒä¸­ï¼ŒKubeleté€šè¿‡è°ƒç”¨éµå¾ªCNIæ ‡å‡†çš„APIä¸å„ç±»ç½‘ç»œæ’ä»¶è¿›è¡Œäº¤äº’ï¼Œä»¥å®ç°å®¹å™¨é—´å¤šæ ·åŒ–çš„ç½‘ç»œè¿æ¥ä¸ç®¡ç†ã€‚æ¥å£å®šä¹‰çš„åŸºæœ¬æ“ä½œåŒ…æ‹¬ <code>ADD</code> å’Œ <code>DEL</code> ç­‰ï¼Œè´Ÿè´£å°†Podæ·»åŠ åˆ°ç½‘ç»œå’Œä»ç½‘ç»œä¸­åˆ é™¤ã€‚</p><p>k8sé€šè¿‡é…ç½®æ–‡ä»¶æ¥è®¾ç½®ä½¿ç”¨çš„CNIæ’ä»¶ã€‚åœ¨åˆ›å»ºpodä¹‹å‰ï¼Œ<a id="ref1"> ç®¡ç†å‘˜å¯ä»¥æ”¾ç½®å¥½CNIé…ç½®æ–‡ä»¶ </a> ï¼Œå½“kubeletåˆ›å»ºpodæ—¶ï¼Œé€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®å…¶ä¸­æŒ‡å®šçš„CNIæ’ä»¶ï¼Œæ‰§è¡Œç›¸åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»è€Œé…ç½®Podç½‘ç»œã€‚å½“kubeletå¯¹Podæ‰§è¡Œ ADD æ“ä½œæ—¶ï¼Œå¯¹åº”çš„CNIæ’ä»¶å°†ä¸ºPodåˆ†é…IPåœ°å€ã€è®¾ç½®è·¯ç”±è§„åˆ™ä»¥åŠå…¶ä»–å¿…è¦çš„ç½‘ç»œé…ç½®ï¼›å½“Podç»ˆæ­¢æˆ–è¢«åˆ é™¤æ—¶ï¼Œkubeletä¼šæ‰§è¡Œ DEL æ“ä½œï¼Œè¿™æ—¶CNIæ’ä»¶è´Ÿè´£æ¸…ç†ç›¸å…³çš„ç½‘ç»œèµ„æºï¼Œå¦‚é‡Šæ”¾IPåœ°å€ç­‰ã€‚</p><p>ä¸åŒçš„CNIæ’ä»¶æœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼Œä¾‹å¦‚Overlayå’ŒUnderlayã€‚å¸¸è§çš„CNIæ’ä»¶æœ‰Calicoå’ŒFlannelç­‰ï¼Œå®ƒä»¬å„è‡ªå…·å¤‡ä¸åŒçš„åŠŸèƒ½ç‰¹ç‚¹ä¸é€‚ç”¨åœºæ™¯ï¼Œä»è€Œæ»¡è¶³ä¸åŒè§„æ¨¡ã€æ€§èƒ½åŠå®‰å…¨éœ€æ±‚çš„å®¹å™¨ç½‘ç»œéƒ¨ç½²è¦æ±‚ã€‚</p><ul><li><p><code>Overlay Network</code></p><ul><li><p>æ˜¯ä¸€ç§è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚é€šè¿‡åœ¨åº•å±‚æ•°æ®åŒ…çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ é¢å¤–çš„å°è£…å¤´éƒ¨ä¿¡æ¯ï¼Œå€ŸåŠ©éš§é“æ‰“é€šç½‘ç»œè¿æ¥ï¼Œå¯ä»¥å±è”½åº•å±‚ç½‘ç»œé€šä¿¡æ–¹å¼çš„å·®å¼‚ï¼Œå…¼å®¹å¤šç§å¼‚æ„åº•å±‚ç½‘ç»œã€‚éƒ¨ç½²æ–¹ä¾¿ï¼›æ‰©å±•æ€§å¥½ã€‚</p></li><li><p>ä¾‹å¦‚ï¼šFlannel-vxlan æ’ä»¶</p></li></ul></li><li><p><code>Underlay Network</code></p><ul><li><p>æä¾›äº†çœŸæ­£çš„ç‰©ç†å±‚å’Œæ•°æ®é“¾è·¯å±‚çš„è¿æ¥ï¼Œç½‘ç»œæ€§èƒ½ç›´æ¥å–å†³äºç¡¬ä»¶è®¾å¤‡ã€‚ç›´æ¥åŸºäºåº•å±‚ä¼ è¾“æ•°æ®ï¼Œæ²¡æœ‰é¢å¤–æ•°æ®å°è£…ï¼Œæ€§èƒ½é«˜ï¼Œååé‡å¤§ï¼Œå»¶è¿Ÿä½ã€‚ä½†åœ¨å¼‚æ„ç½‘ç»œç¯å¢ƒä¸‹æ‰©å±•å›°éš¾ï¼Œç½‘ç»œé…ç½®å¤æ‚ã€‚æŸäº›åŸºäºUnderlayçš„æ’ä»¶æ— æ³•ä½¿ç”¨å¤æ‚å‡è¡¡å’ŒæœåŠ¡å‘ç°ã€‚</p></li><li><p>ä¾‹å¦‚ï¼šclico-bgp æ’ä»¶</p></li></ul></li></ul><p>å®é™…é€‰æ‹©æ—¶ï¼Œè¦ä»å¤šä¸ªéœ€æ±‚å‡ºå‘è€ƒè™‘ï¼Œä¾‹å¦‚å®‰å…¨éœ€æ±‚ã€è´Ÿè½½å‡è¡¡éœ€æ±‚ã€æ€§èƒ½éœ€æ±‚ç­‰ã€‚</p><h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><h3 id="1-åˆ›å»ºé›†ç¾¤ï¼Œä¸é…ç½®CNIæ’ä»¶"><a href="#1-åˆ›å»ºé›†ç¾¤ï¼Œä¸é…ç½®CNIæ’ä»¶" class="headerlink" title="1 åˆ›å»ºé›†ç¾¤ï¼Œä¸é…ç½®CNIæ’ä»¶"></a>1 åˆ›å»ºé›†ç¾¤ï¼Œä¸é…ç½®CNIæ’ä»¶</h3><p><code>kind</code> é»˜è®¤ä½¿ç”¨äº† <code>kindnetd</code> ä½œä¸ºç½‘ç»œæ’ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~$ docker <span class="hljs-built_in">exec</span> -it hello-cluster-worker <span class="hljs-built_in">ls</span> /etc/cni/net.d<br>10-kindnet.conflist<br></code></pre></td></tr></table></figure><p>ä¸ºäº†å®éªŒï¼Œè®¾ç½®åˆ›å»ºé›†ç¾¤æ—¶ä¸é…ç½®CNIæ’ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kind create cluster --name cni-test-cluster --config kind-config.yaml<br><span class="hljs-comment"># åŠ è½½æœ¬åœ°é•œåƒï¼ˆå¦‚æœä¸åŠ è½½ä¼šå‡ºç°ImagePullBackOffã€ErrImagePullç­‰é”™è¯¯ï¼‰</span><br>$ kind load docker-image go-hello-world-image:v0.0.1 --name cni-test-cluster<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># kind-config.yaml</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kind.x-k8s.io/v1alpha4</span><br><span class="hljs-attr">networking:</span><br>  <span class="hljs-comment"># the default CNI will not be installed</span><br>  <span class="hljs-attr">disableDefaultCNI:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">nodes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">control-plane</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ <code>/etc/cni/net.d</code> ä¸‹ç›®å½•ä¸ºç©ºã€‚</p><p>æŸ¥çœ‹ <code>nodes</code>ï¼ŒçŠ¶æ€ä¸º not readyã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get nodes<br>NAME                             STATUS     ROLES           AGE    VERSION<br>cni-test-cluster-control-plane   NotReady   control-plane   2d2h   v1.29.0<br>cni-test-cluster-worker          NotReady   &lt;none&gt;          2d2h   v1.29.0<br>cni-test-cluster-worker2         NotReady   &lt;none&gt;          2d2h   v1.29.0<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ <code>pods</code> ã€‚<code>core-dns</code> å’Œ <code>local-path-provisioner</code> ä¸åœ¨è¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get pods --all-namespaces<br>NAMESPACE            NAME                                                     READY   STATUS    RESTARTS         AGE<br>kube-system          coredns-76f75df574-9swqg                                 0/1     Pending   0                47h<br>kube-system          coredns-76f75df574-j5mgx                                 0/1     Pending   0                47h<br>kube-system          etcd-cni-test-cluster-control-plane                      1/1     Running   0                3m7s<br>kube-system          kube-apiserver-cni-test-cluster-control-plane            1/1     Running   0                3m7s<br>kube-system          kube-controller-manager-cni-test-cluster-control-plane   1/1     Running   7 (3m25s ago)    47h<br>kube-system          kube-proxy-l8cpb                                         1/1     Running   71 (3m25s ago)   47h<br>kube-system          kube-proxy-nwpzn                                         1/1     Running   4 (3m25s ago)    47h<br>kube-system          kube-proxy-zhhfn                                         1/1     Running   71 (3m25s ago)   47h<br>kube-system          kube-scheduler-cni-test-cluster-control-plane            1/1     Running   7 (3m25s ago)    47h<br>local-path-storage   local-path-provisioner-6f8956fb48-f59n6                  0/1     Pending   0                47h<br></code></pre></td></tr></table></figure><p><code>kubectl apply -f cni-deploy.yaml</code> éƒ¨ç½²æœåŠ¡åï¼ŒPodå¤„äºPendingçŠ¶æ€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pods<br>NAME                                   READY   STATUS    RESTARTS   AGE<br>cni-test-deployment-58569cd74c-qrxz5   0/1     Pending   0          142m<br>cni-test-deployment-58569cd74c-v86tf   0/1     Pending   0          142m<br>cni-test-deployment-58569cd74c-wg9rn   0/1     Pending   0          142m<br></code></pre></td></tr></table></figure><h3 id="2-æ‰‹åŠ¨æ·»åŠ flannelæ’ä»¶"><a href="#2-æ‰‹åŠ¨æ·»åŠ flannelæ’ä»¶" class="headerlink" title="2 æ‰‹åŠ¨æ·»åŠ flannelæ’ä»¶"></a>2 æ‰‹åŠ¨æ·»åŠ flannelæ’ä»¶</h3><p>Flannelæ’ä»¶æ—¨åœ¨ä¸ºä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨é‡æ–°è§„åˆ’IPåœ°å€çš„ä½¿ç”¨è§„åˆ™ï¼Œåˆ†é…åŒå±ä¸€ä¸ªå†…ç½‘ä¸”ä¸é‡å¤çš„IPåœ°å€ã€‚</p><h4 id="2-1-å‡†å¤‡å¥½é…ç½®æ–‡ä»¶"><a href="#2-1-å‡†å¤‡å¥½é…ç½®æ–‡ä»¶" class="headerlink" title="2.1 å‡†å¤‡å¥½é…ç½®æ–‡ä»¶"></a>2.1 å‡†å¤‡å¥½é…ç½®æ–‡ä»¶</h4><p>å¦‚<a href="#ref1">ä¸Šæ–‡</a>æåˆ°ï¼Œæ·»åŠ CNIæ’ä»¶éœ€è¦å°†é…ç½®æ–‡ä»¶æ”¾å…¥èŠ‚ç‚¹çš„&#x2F;etc&#x2F;cni&#x2F;net.dã€‚</p><p>å¯ä»¥è‡ªåŠ¨åŒ–åœ°è¿›è¡Œã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># ä¸‹è½½ kube-flannel.yaml æ–‡ä»¶</span><br>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br><span class="hljs-comment"># éƒ¨ç½² flannel</span><br>kubectl apply -f kube-flannel.yml<br></code></pre></td></tr></table></figure><p>èŠ‚ç‚¹å·²ç»å¤„äº <code>Ready</code> çŠ¶æ€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get nodes --all-namespaces<br>NAME                             STATUS   ROLES           AGE    VERSION<br>cni-test-cluster-control-plane   Ready    control-plane   2d2h   v1.29.0<br>cni-test-cluster-worker          Ready    &lt;none&gt;          2d2h   v1.29.0<br>cni-test-cluster-worker2         Ready    &lt;none&gt;          2d2h   v1.29.0<br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å·²è‡ªåŠ¨å†™å…¥å·¥ä½œèŠ‚ç‚¹ <code>/etc/cni/net.d</code> ç›®å½•ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker <span class="hljs-built_in">exec</span> -it cni-test-cluster-worker <span class="hljs-built_in">ls</span> /etc/cni/net.d<br>10-flannel.conflist<br></code></pre></td></tr></table></figure><p>ä½†podsä¾ç„¶æœªå°±ç»ªï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get pods --all-namespaces<br>NAMESPACE            NAME                                                     READY   STATUS              RESTARTS         AGE<br>default              cni-test-deployment-58569cd74c-qrxz5                     0/1     ContainerCreating   0                165m<br>default              cni-test-deployment-58569cd74c-v86tf                     0/1     ContainerCreating   0                165m<br>default              cni-test-deployment-58569cd74c-wg9rn                     0/1     ContainerCreating   0                165m<br>kube-flannel         kube-flannel-ds-bkl5b                                    1/1     Running             0                4m1s<br>kube-flannel         kube-flannel-ds-qfhwm                                    1/1     Running             0                4m1s<br>kube-flannel         kube-flannel-ds-xwn6m                                    1/1     Running             0                4m1s<br>kube-system          coredns-76f75df574-9swqg                                 0/1     ContainerCreating   0                2d2h<br>kube-system          coredns-76f75df574-j5mgx                                 0/1     ContainerCreating   0                2d2h<br>kube-system          etcd-cni-test-cluster-control-plane                      1/1     Running             0                5m31s<br>kube-system          kube-apiserver-cni-test-cluster-control-plane            1/1     Running             0                5m31s<br>kube-system          kube-controller-manager-cni-test-cluster-control-plane   1/1     Running             8 (6m26s ago)    2d2h<br>kube-system          kube-proxy-l8cpb                                         1/1     Running             72 (6m26s ago)   2d2h<br>kube-system          kube-proxy-nwpzn                                         1/1     Running             5 (6m26s ago)    2d2h<br>kube-system          kube-proxy-zhhfn                                         1/1     Running             72 (6m26s ago)   2d2h<br>kube-system          kube-scheduler-cni-test-cluster-control-plane            1/1     Running             8 (6m26s ago)    2d2h<br>local-path-storage   local-path-provisioner-6f8956fb48-f59n6                  0/1     ContainerCreating   0                2d2h<br><br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>kubectl describe pod cni-test-deployment-58569cd74c-qrxz5</code> æŸ¥çœ‹ä¿¡æ¯ï¼Œæç¤ºåœ¨å§”æ´¾ <code>ADD</code> æ“ä½œæ—¶ï¼Œæ— æ³•æ‰¾åˆ° <code>/opt/cni/bin</code> ç›®å½•ä¸‹çš„<code>bridge</code>äºŒè¿›åˆ¶æ–‡ä»¶æ’ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl describe pod cni-test-deployment-58569cd74c-qrxz5<br>...<br>Conditions:<br>  Type                        Status<br>  PodReadyToStartContainers   False <br>  Initialized                 True <br>  Ready                       False <br>  ContainersReady             False <br>  PodScheduled                True <br>Events:<br>  Type     Reason                  Age                     From               Message<br>  ----     ------                  ----                    ----               -------<br>  Warning  FailedCreatePodSandBox  4m16s                   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network <span class="hljs-keyword">for</span> sandbox <span class="hljs-string">&quot;0ca3e187ace57dd4af46bb8e4c60b5b5973510f5f4a02e8efe1954d34f1b7101&quot;</span>: plugin <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;flannel&quot;</span> failed (add): failed to delegate add: failed to find plugin <span class="hljs-string">&quot;bridge&quot;</span> <span class="hljs-keyword">in</span> path [/opt/cni/bin]<br></code></pre></td></tr></table></figure><h4 id="2-2-æ‰‹åŠ¨å®‰è£…æ’ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#2-2-æ‰‹åŠ¨å®‰è£…æ’ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="2.2 æ‰‹åŠ¨å®‰è£…æ’ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>2.2 æ‰‹åŠ¨å®‰è£…æ’ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶</h4><p>åœ¨è¿è¡Œ kind çš„å®¿ä¸»æœºä¸Šä¸‹è½½æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½æ–‡ä»¶</span><br>$ wget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz<br></code></pre></td></tr></table></figure><p>å¤åˆ¶åˆ°å¤šä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆdockerå®¹å™¨ï¼‰ï¼Œå¹¶è§£å‹ã€‚åˆ›å»ºè„šæœ¬è‡ªåŠ¨å¤„ç†è¿™ä¸€è¿‡ç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ./unzip_to_docker.sh</span><br><br><span class="hljs-comment"># è·å–æ‰€æœ‰åç§°ä»¥ &#x27;cni-test-cluster&#x27; å¼€å¤´çš„å®¹å™¨</span><br>container_names=$(docker ps --format <span class="hljs-string">&quot;&#123;&#123;.Names&#125;&#125;&quot;</span> | grep <span class="hljs-string">&#x27;^cni-test-cluster&#x27;</span>)<br><br><span class="hljs-comment"># å®šä¹‰æœ¬åœ°å‹ç¼©æ–‡ä»¶è·¯å¾„å’Œç›®æ ‡è§£å‹ç›®å½•ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™…å€¼ï¼‰</span><br>local_archive=<span class="hljs-string">&quot;cni-plugins-linux-amd64-v1.4.0.tgz&quot;</span><br>target_directory=<span class="hljs-string">&quot;/opt/cni/bin&quot;</span><br><br><span class="hljs-comment"># éå†æ¯ä¸ªåŒ¹é…åˆ°çš„å®¹å™¨</span><br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> <span class="hljs-variable">$container_names</span>; <span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># å°†æœ¬åœ°å‹ç¼©æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨å†…</span><br>    docker <span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;<span class="hljs-variable">$local_archive</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$name</span>:<span class="hljs-variable">$target_directory</span>&quot;</span><br>    <span class="hljs-comment"># åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œè§£å‹å‘½ä»¤</span><br>    docker <span class="hljs-built_in">exec</span> -it <span class="hljs-string">&quot;<span class="hljs-variable">$name</span>&quot;</span> bash -c <span class="hljs-string">&quot;cd &#x27;<span class="hljs-variable">$target_directory</span>&#x27; &amp;&amp; tar -zxvf &#x27;<span class="hljs-variable">$local_archive</span>&#x27;&quot;</span><br>    <span class="hljs-comment"># å±•ç¤ºæ–‡ä»¶å¤¹ä¸‹å†…å®¹</span><br>    docker <span class="hljs-built_in">exec</span> -it <span class="hljs-string">&quot;<span class="hljs-variable">$name</span>&quot;</span> bash -c <span class="hljs-string">&quot;cd &#x27;<span class="hljs-variable">$target_directory</span>&#x27; &amp;&amp; ls&quot;</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Finished deploying files to containers.&quot;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿è¡Œ kind çš„å®¿ä¸»æœºä¸Šè¿è¡Œæ­¤è„šæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ bash unzip_to_docker.sh <br>Successfully copied 46.9MB to cni-test-cluster-control-plane:/opt/cni/bin<br>./<br>./loopback<br>./bandwidth<br>./ptp<br>./vlan<br>./host-device<br>./tuning<br>./vrf<br>./sbr<br>./tap<br>./dhcp<br>./static<br>./firewall<br>./macvlan<br>./dummy<br>./bridge<br>./ipvlan<br>./portmap<br>./host-local<br>bandwidth  cni-plugins-linux-amd64-v1.4.0.tgz  dummy flannel      host-local  loopback  portmap  sbr     tap     vlan<br>bridge   dhcp       firewall  host-device  ipvlan  macvlan   ptp      static  tuning  vrf<br>Successfully copied 46.9MB to cni-test-cluster-worker2:/opt/cni/bin<br>./<br>./loopback<br>./bandwidth<br>./ptp<br>./vlan<br>./host-device<br>./tuning<br>./vrf<br>./sbr<br>./tap<br>./dhcp<br>./static<br>./firewall<br>./macvlan<br>./dummy<br>./bridge<br>./ipvlan<br>./portmap<br>./host-local<br>bandwidth  cni-plugins-linux-amd64-v1.4.0.tgz  dummy flannel      host-local  loopback  portmap  sbr     tap     vlan<br>bridge   dhcp       firewall  host-device  ipvlan  macvlan   ptp      static  tuning  vrf<br>Successfully copied 46.9MB to cni-test-cluster-worker:/opt/cni/bin<br>./<br>./loopback<br>./bandwidth<br>./ptp<br>./vlan<br>./host-device<br>./tuning<br>./vrf<br>./sbr<br>./tap<br>./dhcp<br>./static<br>./firewall<br>./macvlan<br>./dummy<br>./bridge<br>./ipvlan<br>./portmap<br>./host-local<br>bandwidth  cni-plugins-linux-amd64-v1.4.0.tgz  dummy flannel      host-local  loopback  portmap  sbr     tap     vlan<br>bridge   dhcp       firewall  host-device  ipvlan  macvlan   ptp      static  tuning  vrf<br>Finished deploying files to containers.<br></code></pre></td></tr></table></figure><p>è¿›å…¥workNodeæŸ¥çœ‹ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°ç½‘å¡flannel.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker <span class="hljs-built_in">exec</span> -it cni-test-cluster-worker /bin/bash<br>root@cni-test-cluster-worker:/<span class="hljs-comment"># ip a</span><br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    <span class="hljs-built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default <br>    <span class="hljs-built_in">link</span>/ether a6:b3:45:67:33:b2 brd ff:ff:ff:ff:ff:ff<br>    inet 10.244.1.0/32 scope global flannel.1<br>       valid_lft forever preferred_lft forever<br>10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default <br>    <span class="hljs-built_in">link</span>/ether 02:42:ac:12:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br>    inet 172.18.0.4/16 brd 172.18.255.255 scope global eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fc00:f853:ccd:e793::4/64 scope global nodad <br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::42:acff:fe12:4/64 scope <span class="hljs-built_in">link</span> <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>è¿›å…¥masterNodeåï¼Œæ£€æŸ¥å­ç½‘ç¯å¢ƒå˜é‡ï¼Œå·²å†™å…¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@cni-test-cluster-control-plane:/var/run/flannel<span class="hljs-comment"># cat subnet.env </span><br>FLANNEL_NETWORK=10.244.0.0/16<br>FLANNEL_SUBNET=10.244.0.1/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>æ£€æŸ¥podsï¼Œ<code>coredns</code> å’Œè‡ªå®šä¹‰çš„pod <code>cni-test-deployment</code> å·²æ­£å¸¸è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get pods --all-namespaces<br>NAMESPACE            NAME                                                     READY   STATUS    RESTARTS       AGE<br>default              cni-test-deployment-58569cd74c-7hdmp                     1/1     Running   0              9m52s<br>default              cni-test-deployment-58569cd74c-9wcqw                     1/1     Running   0              9m52s<br>default              cni-test-deployment-58569cd74c-bbwhk                     1/1     Running   0              9m52s<br>kube-flannel         kube-flannel-ds-7dfkb                                    1/1     Running   1 (35m ago)    56m<br>kube-flannel         kube-flannel-ds-vfvbz                                    1/1     Running   1 (35m ago)    56m<br>kube-flannel         kube-flannel-ds-zc88f                                    1/1     Running   2 (34m ago)    56m<br>kube-system          coredns-76f75df574-9swqg                                 1/1     Running   0              2d3h<br>kube-system          coredns-76f75df574-j5mgx                                 1/1     Running   0              2d3h<br>kube-system          etcd-cni-test-cluster-control-plane                      1/1     Running   1 (35m ago)    95m<br>kube-system          kube-apiserver-cni-test-cluster-control-plane            1/1     Running   1 (35m ago)    95m<br>kube-system          kube-controller-manager-cni-test-cluster-control-plane   1/1     Running   9 (35m ago)    2d3h<br>kube-system          kube-proxy-l8cpb                                         1/1     Running   73 (35m ago)   2d3h<br>kube-system          kube-proxy-nwpzn                                         1/1     Running   6 (35m ago)    2d3h<br>kube-system          kube-proxy-zhhfn                                         1/1     Running   73 (35m ago)   2d3h<br>kube-system          kube-scheduler-cni-test-cluster-control-plane            1/1     Running   9 (35m ago)    2d3h<br>local-path-storage   local-path-provisioner-6f8956fb48-f59n6                  1/1     Running   0              2d3h<br></code></pre></td></tr></table></figure><p>è¿›å…¥åœ¨ <code>worker2</code> èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ <code>IP = 10.244.2.7</code> çš„pod ï¼Œè®¿é—®åœ¨ <code>worker</code> èŠ‚ç‚¹ä¸Šè¿è¡Œçš„<code>IP = 10.244.1.8</code> çš„podï¼Œå¯ä»¥è®¿é—®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl get pods -owide<br>NAME                                   READY   STATUS    RESTARTS   AGE   IP           NODE                       NOMINATED NODE   READINESS GATES<br>cni-test-deployment-58569cd74c-7hdmp   1/1     Running   0          11m   10.244.2.7   cni-test-cluster-worker2   &lt;none&gt;           &lt;none&gt;<br>cni-test-deployment-58569cd74c-9wcqw   1/1     Running   0          11m   10.244.1.8   cni-test-cluster-worker    &lt;none&gt;           &lt;none&gt;<br>cni-test-deployment-58569cd74c-bbwhk   1/1     Running   0          11m   10.244.1.7   cni-test-cluster-worker    &lt;none&gt;           &lt;none&gt;<br><br>$ kubectl <span class="hljs-built_in">exec</span> cni-test-deployment-58569cd74c-7hdmp -it sh<br>/app <span class="hljs-comment"># curl 10.244.1.8:8080/test</span><br>hello world<br>/app <span class="hljs-comment"># exit</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>kubelabs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
      <tag>cni</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€1ã€‘ä½¿ç”¨ kind æ­å»ºæœ¬åœ°é›†ç¾¤</title>
    <link href="/2024/01/14/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_1_%E6%90%AD%E5%BB%BA%E6%9C%AC%E5%9C%B0%E9%9B%86%E7%BE%A4/"/>
    <url>/2024/01/14/k8s%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93_1_%E6%90%AD%E5%BB%BA%E6%9C%AC%E5%9C%B0%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€1ã€‘ä½¿ç”¨-kind-æ­å»ºæœ¬åœ°é›†ç¾¤"><a href="#kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€1ã€‘ä½¿ç”¨-kind-æ­å»ºæœ¬åœ°é›†ç¾¤" class="headerlink" title="kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€1ã€‘ä½¿ç”¨ kind æ­å»ºæœ¬åœ°é›†ç¾¤"></a>kubelabsâ€”â€”k8så­¦ä¹ ä¸å®éªŒã€1ã€‘ä½¿ç”¨ kind æ­å»ºæœ¬åœ°é›†ç¾¤</h1><h2 id="1-æ¦‚å¿µæ€»ç»“"><a href="#1-æ¦‚å¿µæ€»ç»“" class="headerlink" title="1 æ¦‚å¿µæ€»ç»“"></a>1 æ¦‚å¿µæ€»ç»“</h2><h3 id="1-1-kubernetesï¼ˆk8sï¼‰"><a href="#1-1-kubernetesï¼ˆk8sï¼‰" class="headerlink" title="1.1 kubernetesï¼ˆk8sï¼‰"></a>1.1 kubernetesï¼ˆk8sï¼‰</h3><ul><li>kubernetesï¼ˆk8sï¼‰æ˜¯ç”¨äºç®¡ç†äº‘å¹³å°ä¸­çš„å¤šä¸ªå®¹å™¨åŒ–åº”ç”¨çš„å·¥å…·ã€‚</li><li>ç†è§£ï¼š<ul><li>ç°åœ¨çš„å¤§å‹ç¨‹åºè¢«åˆ†å‰²ä¸ºå¤šä¸ªæœåŠ¡ï¼Œå„è‡ªè¿è¡Œåœ¨å•ç‹¬çš„å®¹å™¨é‡Œã€‚</li><li>ä¸ºäº†æå‡æ€§èƒ½å’Œå¯ç”¨æ€§ï¼Œå¤šä¸ªå®¹å™¨éœ€è¦åˆ†æ•£åœ¨å¤šä¸ªç‰©ç†æœºå™¨ä¸Šï¼Œå¹¶æ‹¥æœ‰å¤‡ä»½ã€‚</li><li>å¤šä¸ªæœåŠ¡å’Œå®¹å™¨éœ€è¦é€šä¿¡</li><li>k8sç”¨äºè‡ªåŠ¨åŒ–ç®¡ç†æ­¤ç³»ç»Ÿã€‚</li></ul></li></ul><h3 id="1-2-ç»„æˆ"><a href="#1-2-ç»„æˆ" class="headerlink" title="1.2 ç»„æˆ"></a>1.2 ç»„æˆ</h3><h4 id="ç‰©ç†å±‚é¢"><a href="#ç‰©ç†å±‚é¢" class="headerlink" title="ç‰©ç†å±‚é¢"></a>ç‰©ç†å±‚é¢</h4><ul><li>MasterèŠ‚ç‚¹<ul><li>ç‰©ç†æœåŠ¡å™¨</li><li>kubectlï¼šæ“ä½œk8sçš„å‘½ä»¤è¡Œå·¥å…·ã€‚æ·»åŠ deploymentã€serviceç­‰ã€‚</li><li>apiServerï¼šå¯¹è±¡çš„è¯·æ±‚å’Œè°ƒç”¨æ“ä½œé€šè¿‡æ­¤æ¨¡å—æä¾›çš„æ¥å£è¿›è¡Œã€‚</li><li>kube-schedulerï¼šèµ„æºè°ƒåº¦</li><li>kube-controller-managerï¼šç»´æŠ¤é›†ç¾¤çŠ¶æ€</li><li>etcdåˆ†å¸ƒå¼å­˜å‚¨ï¼šä¿å­˜é›†ç¾¤çŠ¶æ€</li></ul></li><li>WorkerèŠ‚ç‚¹<ul><li>ç‰©ç†æœåŠ¡å™¨</li><li>kubeletï¼šåˆ›å»ºå’Œç®¡ç†podï¼›ä¸masteré€šè®¯</li><li>kube-proxyï¼šè´Ÿè´£ä¸åŒpodé€šä¿¡ã€‚</li><li>èµ„æºï¼ˆPodç­‰ï¼‰</li></ul></li></ul><h4 id="é€»è¾‘å±‚é¢"><a href="#é€»è¾‘å±‚é¢" class="headerlink" title="é€»è¾‘å±‚é¢"></a>é€»è¾‘å±‚é¢</h4><ul><li><p>ä¸»è¦èµ„æºå¯¹è±¡</p><ul><li>Containerï¼šå®¹å™¨åŒ–åº”ç”¨ã€‚</li><li>Podï¼šk8såˆ›å»ºæˆ–é”€æ¯çš„æœ€å°å•ä½ã€‚ä¸€ä¸ªpodåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚Podä¸­å®¹å™¨å…±äº«ç½‘ç»œã€å­˜å‚¨å’Œè®¡ç®—èµ„æºã€‚</li><li>Serviceï¼šé€šè¿‡labelsç»‘å®špodï¼Œæä¾›Cluster IPåœ°å€å’ŒæœåŠ¡åæ¥è®¿é—®Podèµ„æºã€‚å¥½å¤„æ˜¯å¯ä»¥å®ç°å¤šä¸ªPodè´Ÿè½½å‡è¡¡ï¼Œå¹¶å›ºå®šè®¿é—®çš„urlï¼ŒPod IPæˆ–Cluster IPå˜åŠ¨æ—¶ä¸ä¼šäº§ç”Ÿå½±å“ã€‚</li><li>Deploymentï¼šç®¡ç†å’Œæ§åˆ¶Podçš„æ•°é‡ï¼Œç¡®ä¿æ¯æ—¶æ¯åˆ»æœ‰ç”¨æˆ·è¦æ±‚æ•°é‡çš„ Pod åœ¨å·¥ä½œï¼ŒæŸPodå‡ºç°é—®é¢˜å°±é‡æ–°æ‹‰èµ·ã€‚</li></ul></li><li><p>ä¸ºäº†æ›´å¥½çš„æä¾›å¼€æ”¾ã€æ‰©å±•ã€è§„èŒƒç­‰èƒ½åŠ›çš„è§„èŒƒ</p><ul><li>CNIï¼šå®¹å™¨ç½‘ç»œæ¥å£ã€‚å®šä¹‰é€šä¿¡è§„èŒƒï¼Œå±è”½åº•å±‚ä½¿ç”¨ä¸åŒç½‘ç»œæ’ä»¶çš„å·®å¼‚ã€‚</li><li>CSIï¼šå®¹å™¨å­˜å‚¨æ¥å£ã€‚å°†ä»»æ„å­˜å‚¨ç³»ç»Ÿè§„èŒƒåœ°æš´éœ²ç»™å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚</li><li>CRIï¼šå®¹å™¨è¿è¡Œæ—¶æ¥å£ã€‚å®šä¹‰è§„èŒƒï¼Œä½¿k8så¯ä»¥å…¼å®¹å¤šç§å®¹å™¨å¼•æ“ï¼Œå¦‚dockerã€fraktiç­‰ã€‚</li></ul></li></ul><h2 id="2-å®éªŒæ“ä½œ"><a href="#2-å®éªŒæ“ä½œ" class="headerlink" title="2 å®éªŒæ“ä½œ"></a>2 å®éªŒæ“ä½œ</h2><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><ul><li>å®¿ä¸»æœºï¼šWindowsä¸‹é€šè¿‡vmwareè¿è¡Œçš„Ubuntuã€‚ç£ç›˜ï¼š30GBï¼Œå†…å­˜ï¼š5.2G  </li><li>é€‰æ‹©ç”¨kindæ­å»ºé›†ç¾¤</li></ul><h3 id="2-2-è‡ªåˆ¶æœåŠ¡é•œåƒ"><a href="#2-2-è‡ªåˆ¶æœåŠ¡é•œåƒ" class="headerlink" title="2.2 è‡ªåˆ¶æœåŠ¡é•œåƒ"></a>2.2 è‡ªåˆ¶æœåŠ¡é•œåƒ</h3><ul><li>go æœåŠ¡<br>è¯·æ±‚ip:8080&#x2F;testè¿”å›å­—ç¬¦ä¸²â€hello worldâ€</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>        <span class="hljs-string">&quot;fmt&quot;</span><br>        <span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helloWorld</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> r.Method == http.MethodGet &amp;&amp; r.URL.Path == <span class="hljs-string">&quot;/test&quot;</span> &#123;<br>                w.WriteHeader(http.StatusOK)<br>                fmt.Fprintln(w, <span class="hljs-string">&quot;hello world&quot;</span>)<br>                <span class="hljs-keyword">return</span><br>        &#125;<br>        http.NotFound(w, r)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>        http.HandleFunc(<span class="hljs-string">&quot;/test&quot;</span>, helloWorld)<br><br>        <span class="hljs-comment">// ç›‘å¬å¹¶åœ¨ 8080 ç«¯å£å¯åŠ¨æœåŠ¡</span><br>        fmt.Println(<span class="hljs-string">&quot;Server is listening on port 8080...&quot;</span>)<br>        http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">ARG</span> IMAGE_VERSION=v0.<span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># ä½¿ç”¨å®˜æ–¹çš„GolangåŸºç¡€é•œåƒä½œä¸ºçˆ¶é•œåƒ</span><br><span class="hljs-keyword">FROM</span> golang:latest as builder<br><br><span class="hljs-comment"># è®¾ç½®å·¥ä½œç›®å½•</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><br><span class="hljs-comment"># å°†é¡¹ç›®æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„å·¥ä½œç›®å½•ä¸­</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span><br><br><span class="hljs-keyword">ENV</span> CGO_ENABLED=<span class="hljs-number">0</span><br><br><span class="hljs-comment"># æ„å»ºåº”ç”¨</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> go build -o main .</span><br><br><span class="hljs-comment"># ä½¿ç”¨ä¸€ä¸ªæ–°çš„è½»é‡çº§åŸºç¡€é•œåƒï¼Œä¾‹å¦‚Alpine</span><br><span class="hljs-keyword">FROM</span> alpine:latest<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apk update</span><br><br><span class="hljs-comment"># å®‰è£…curlå’Œå…¶ä»–å¯èƒ½éœ€è¦çš„ä¾èµ–</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apk add --no-cache curl</span><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><br><span class="hljs-comment"># å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æ–°é•œåƒä¸­</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/main /app/</span><br><br><span class="hljs-comment"># è®¾ç½®å·¥ä½œç›®å½•å’Œæä¾›è¿è¡Œæ—¶ç¯å¢ƒ</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;./main&quot;</span>]</span><br><br><span class="hljs-comment"># å£°æ˜è¿è¡Œæ—¶å®¹å™¨æä¾›çš„æœåŠ¡ç«¯å£</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br></code></pre></td></tr></table></figure><ul><li>è¿è¡Œå‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t go-hello-world-image:v0.0.1 .<br></code></pre></td></tr></table></figure><h3 id="2-3-kindåˆ›å»ºé›†ç¾¤"><a href="#2-3-kindåˆ›å»ºé›†ç¾¤" class="headerlink" title="2.3 kindåˆ›å»ºé›†ç¾¤"></a>2.3 kindåˆ›å»ºé›†ç¾¤</h3><ul><li>æ–‡ä»¶ç»“æ„</li></ul><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs txt">â”œâ”€â”€ go-hello<br>â”‚Â Â  â”œâ”€â”€ app<br>â”‚Â Â  â”œâ”€â”€ Dockerfile<br>â”‚Â Â  â”œâ”€â”€ go.mod<br>â”‚Â Â  â””â”€â”€ main.go<br>â”œâ”€â”€ hello-deploy.yaml<br>â”œâ”€â”€ hello-service.yaml<br>â”œâ”€â”€ kind-config.yaml<br>â”œâ”€â”€ nginx-deployment.yaml<br>â””â”€â”€ nginx-service.yaml<br></code></pre></td></tr></table></figure><ul><li>é›†ç¾¤é…ç½®æ–‡ä»¶ï¼škind-config.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kind.x-k8s.io/v1alpha4</span><br><span class="hljs-attr">nodes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">control-plane</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span> <span class="hljs-comment"># æŒ‡å®šworknodeé•œåƒ</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">kindest/node:v1.29.0</span><br></code></pre></td></tr></table></figure><ul><li>deploymenté…ç½®æ–‡ä»¶ï¼šhello-deploy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">go-hello-world-deployment</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">go-hello-world</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">go-hello-world</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">go-hello-world-container</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">go-hello-world-image:v0.0.1</span> <span class="hljs-comment"># æ›¿æ¢ä¸ºæ‚¨çš„é•œåƒåç§°å’Œæ ‡ç­¾</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span> <span class="hljs-comment"># å‡è®¾æœåŠ¡ç›‘å¬åœ¨å®¹å™¨å†…éƒ¨çš„8080ç«¯å£</span><br></code></pre></td></tr></table></figure><ul><li>serviceé…ç½®æ–‡ä»¶ï¼šhello-service.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">hello-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span> <span class="hljs-comment"># æˆ–è€… LoadBalancer å¦‚æœåœ¨æ¨¡æ‹Ÿäº‘ç¯å¢ƒä¸­</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">go-hello-world</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">30007</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30008</span> <span class="hljs-comment"># å¦‚æœæ˜¯NodePortç±»å‹ï¼Œè®¾ç½®ä¸€ä¸ªå¯ç”¨ç«¯å£</span><br></code></pre></td></tr></table></figure><ul><li>æ­å»ºé›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºé›†ç¾¤</span><br>kind create cluster --name hello-cluster --config kind-config.yaml<br><span class="hljs-comment"># åŠ è½½é•œåƒ</span><br>kind load docker-image go-hello-world-image:v0.0.1 --name hello-cluster<br><span class="hljs-comment"># åˆ›å»º deployment</span><br>kubectl apply -f hello-deploy.yaml<br><span class="hljs-comment"># åˆ›å»º service</span><br>kubectl apply -f hello-service.yaml<br></code></pre></td></tr></table></figure><ul><li>Dockerä¿¡æ¯æ¦‚è§ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/hello$ docker ps<br>CONTAINER ID   IMAGE                         COMMAND                  CREATED       STATUS       PORTS                                         NAMES<br>a20802131005   kindest/node:v1.29.0          <span class="hljs-string">&quot;/usr/local/bin/entrâ€¦&quot;</span>   4 hours ago   Up 4 hours                                                 hello-cluster-worker<br>710f6226c8ab   kindest/node:v1.29.0          <span class="hljs-string">&quot;/usr/local/bin/entrâ€¦&quot;</span>   4 hours ago   Up 4 hours   127.0.0.1:35839-&gt;6443/tcp                     hello-cluster-control-plane<br>c21dc643b049   kindest/node:v1.29.0          <span class="hljs-string">&quot;/usr/local/bin/entrâ€¦&quot;</span>   4 hours ago   Up 4 hours                                                 hello-cluster-worker2<br>bc232db8553e   go-hello-world-image:v0.0.1   <span class="hljs-string">&quot;./main&quot;</span>                 4 hours ago   Up 4 hours   0.0.0.0:10086-&gt;8080/tcp, :::10086-&gt;8080/tcp   hello-local<br></code></pre></td></tr></table></figure><ul><li>nodesä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/hello$ kubectl get nodes -o wide<br>NAME                          STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME<br>hello-cluster-control-plane   Ready    control-plane   3h41m   v1.29.0   172.18.0.2    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-91-generic   containerd://1.7.1<br>hello-cluster-worker          Ready    &lt;none&gt;          3h41m   v1.29.0   172.18.0.4    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-91-generic   containerd://1.7.1<br>hello-cluster-worker2         Ready    &lt;none&gt;          3h41m   v1.29.0   172.18.0.3    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.15.0-91-generic   containerd://1.7.1<br></code></pre></td></tr></table></figure><ul><li>podsä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/hello$ kubectl get pods -o wide<br>NAME                                         READY   STATUS    RESTARTS   AGE     IP           NODE                    NOMINATED NODE   READINESS GATES<br>go-hello-world-deployment-58569cd74c-85hw5   1/1     Running   0          3h33m   10.244.1.5   hello-cluster-worker    &lt;none&gt;           &lt;none&gt;<br>go-hello-world-deployment-58569cd74c-bd8ht   1/1     Running   0          3h33m   10.244.2.3   hello-cluster-worker2   &lt;none&gt;           &lt;none&gt;<br>go-hello-world-deployment-58569cd74c-qgfm7   1/1     Running   0          3h33m   10.244.1.4   hello-cluster-worker    &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure><ul><li>serviceä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/hello$ kubectl get service -o wide<br>NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE     SELECTOR<br>hello-service   NodePort    10.96.2.242   &lt;none&gt;        8080:30008/TCP   3h13m   app=go-hello-world<br>kubernetes      ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP          3h42m   &lt;none&gt;<br></code></pre></td></tr></table></figure><h3 id="2-4-ç»“æœä¸é—®é¢˜"><a href="#2-4-ç»“æœä¸é—®é¢˜" class="headerlink" title="2.4 ç»“æœä¸é—®é¢˜"></a>2.4 ç»“æœä¸é—®é¢˜</h3><p>ä½¿ç”¨Kindåˆ›å»ºäº†é›†ç¾¤ã€‚è‡ªå®šä¹‰çš„æœåŠ¡ç›‘å¬ <code>port = 8080</code>ï¼Œserviceç›‘å¬ <code>sport = 30007</code>ï¼Œåœ¨workNodeä¸Šå¼€æ”¾ <code>NodePort=30008</code>ã€‚</p><h4 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h4><h5 id="1-è¿›å…¥åˆ°podå†…éƒ¨"><a href="#1-è¿›å…¥åˆ°podå†…éƒ¨" class="headerlink" title="1 è¿›å…¥åˆ°podå†…éƒ¨"></a>1 è¿›å…¥åˆ°podå†…éƒ¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">yzq@ubuntu:~/Documents/k8s-proj/hello$ kubectl <span class="hljs-built_in">exec</span> -it go-hello-world-deployment-58569cd74c-85hw5 sh<br>kubectl <span class="hljs-built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="hljs-keyword">in</span> a future version. Use kubectl <span class="hljs-built_in">exec</span> [POD] -- [COMMAND] instead.<br>/app <span class="hljs-comment"># curl localhost:8080/test</span><br>hello world<br>/app <span class="hljs-comment"># curl 10.244.1.4:8080/test</span><br>hello world<br>/app <span class="hljs-comment"># curl 10.96.2.242:30007/test</span><br>hello world<br>/app <span class="hljs-comment"># curl hello-service:30007/test</span><br>hello world<br></code></pre></td></tr></table></figure><ul><li>å¯ä»¥ç”¨ <code>localhost:port</code>è®¿é—®æœ¬podæœåŠ¡</li><li>å¯ä»¥ç”¨ <code>pod ip:port</code>è®¿é—®å¯¹åº”podçš„æœåŠ¡</li><li>åˆ›å»ºServiceåï¼Œå¯ä»¥ç”¨ <code>clusterIP:sport</code>å¯ä»¥è®¿é—®æœåŠ¡</li><li>åˆ›å»ºServiceåï¼Œ<strong>æ— æ³•</strong>é€šè¿‡ <code>hello-service:sport</code>è®¿é—®æœåŠ¡ <a href="#bug1">[1]</a></li></ul><h5 id="2-è¿›å…¥åˆ°workNodeå†…éƒ¨"><a href="#2-è¿›å…¥åˆ°workNodeå†…éƒ¨" class="headerlink" title="2 è¿›å…¥åˆ°workNodeå†…éƒ¨"></a>2 è¿›å…¥åˆ°workNodeå†…éƒ¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it hello-cluster-worker sh<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>localhost:NodePort</code>å¯ä»¥è®¿é—®æœ¬workNodeä¸Šçš„æœåŠ¡ï¼›</li><li>ä½¿ç”¨ <code>WorkNodeIp:NodePort</code>å’Œ <code>å…¶ä»–WorkNodeIp:NodePort</code><strong>æ— æ³•</strong>è®¿é—®æœåŠ¡ <a href="#bug2">[2]</a></li></ul><h4 id="é—®é¢˜ä¸è§£å†³"><a href="#é—®é¢˜ä¸è§£å†³" class="headerlink" title="é—®é¢˜ä¸è§£å†³"></a>é—®é¢˜ä¸è§£å†³</h4><p><a id="bug1">[1]</a> æ£€æŸ¥kube-dnsï¼Œæ— æ˜æ˜¾é”™è¯¯ï¼Œé‡å¯åè§£å†³ã€‚</p><p><a id="bug2">[2]</a> æ’æŸ¥è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>æ£€æŸ¥ <code>ufw</code>é˜²ç«å¢™ï¼šæœªå¼€å¯é˜²ç«å¢™</p></li><li><p>æ£€æŸ¥CNIæ—¥å¿—ï¼ŒworkNodeæ‹¥æœ‰å­ç½‘æ®µï¼Œå¯ä»¥åˆ†é…ç»™pod<br>Node hello-cluster-control-plane has CIDR [<code>10.244.0.0/24</code>]<br>Node hello-cluster-worker has CIDR [<code>10.244.1.0/24</code>]<br>Node hello-cluster-worker2 has CIDR [<code>10.244.2.0/24</code>]</p></li><li><p>æ£€æŸ¥ <code>ping</code>ï¼šå¯ä»¥pingé€šIP</p></li><li><p>é€šè¿‡ <code>curl -v</code> æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œå‘ç°èµ°äº†ä»£ç† <code>192.168.115.1</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Windowsçš„IPä¸º192.168.115.1ï¼›åœ¨è¿™ä¸ªwindowsé‡Œé¢ï¼Œæˆ‘è¿è¡Œäº†ä¸€ä¸ªubuntuè™šæ‹Ÿæœºï¼ŒIPä¸º192.168.115.128ï¼›</span><br><span class="hljs-comment"># windowsä¸Šçš„7890ç«¯å£è®¾ç½®äº†ä»£ç†æœåŠ¡å™¨ï¼Œç”¨äºè®¿é—®èµ„æºï¼›</span><br><span class="hljs-comment"># ä¸ºäº†è®©ubuntuè™šæ‹ŸæœºåŒæ ·èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œæˆ‘é…ç½®ubuntuçš„ä»£ç†æœåŠ¡å™¨ä¸º192.168.115.1:7890ï¼›   </span><br><br>curl -v 172.18.0.3:30008<br><br>* Uses proxy <span class="hljs-built_in">env</span> variable no_proxy == <span class="hljs-string">&#x27;172.18.0.0/16,fc00:f853:ccd:e793::/64,localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24,::1,10.96.0.0/16,10.244.0.0/16,hello-cluster-control-plane,hello-cluster-worker,hello-cluster-worker2,.svc,.svc.cluster,.svc.cluster.local&#x27;</span><br>* Uses proxy <span class="hljs-built_in">env</span> variable http_proxy == <span class="hljs-string">&#x27;http://192.168.115.1:7890/&#x27;</span><br>*   Trying 192.168.115.1:7890...<br>* Connected to 192.168.115.1 (192.168.115.1) port 7890 (<span class="hljs-comment">#0)</span><br>&gt; GET http://172.18.0.3:30008/ HTTP/1.1<br>&gt; Host: 172.18.0.3:30008<br>&gt; User-Agent: curl/7.74.0<br>&gt; Accept: */*<br>&gt; Proxy-Connection: Keep-Alive<br>&gt; <br>* Mark bundle as not supporting multiuse<br>&lt; HTTP/1.1 502 Bad Gateway<br>&lt; Connection: keep-alive<br>&lt; Keep-Alive: <span class="hljs-built_in">timeout</span>=4<br>&lt; Proxy-Connection: keep-alive<br>&lt; Content-Length: 0<br>&lt; <br></code></pre></td></tr></table></figure></li><li><p><code>curl --noproxy</code>ï¼šå¼ºåˆ¶ä½¿ç”¨curlä¸èµ°ä»£ç†ï¼Œè®¿é—®æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl -v --noproxy &#x27;*&#x27; 172.18.0.3:30008/test</span><br>hello world<br></code></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥workNodeä¸Šçš„ç¯å¢ƒå˜é‡ï¼šç¡®å®å­˜åœ¨no_proxyç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># env | grep no_proxy</span><br>no_proxy=172.18.0.0/16,fc00:f853:ccd:e793::/64,localhost,127.0.0.1,10.96.0.0/12,192.168.59.0/24,192.168.49.0/24,192.168.39.0/24,::1,10.96.0.0/16,10.244.0.0/16,hello-cluster-control-plane,hello-cluster-worker,hello-cluster-worker2,.svc,.svc.cluster,.svc.cluster.local<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨å…¶ä»–å·¥å…· <code>wget</code>è®¿é—®æ¥å£ï¼šä¹Ÿèµ°äº†ä»£ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># wget -O - http://172.18.0.3:30008/test</span><br></code></pre></td></tr></table></figure></li><li><p>ç°åœ¨é—®é¢˜å·²ç»åœ¨äºï¼šåœ¨kindåˆ›å»ºçš„è¿™ä¸ªworkNodeä¸­ï¼ŒpathåŒ…å«äº†proxyå’Œno_proxyï¼Œä½†no_proxyæ²¡æœ‰èµ·ä½œç”¨ï¼Œåœ¨curlå’Œwgetéƒ½å‡ºç°è¿™ä¸ªç°è±¡ã€‚</p></li><li><p>å›åˆ°vmware ubuntuç•Œé¢ï¼ŒæŠŠæ•´ä¸ªè™šæ‹Ÿæœºçš„ä»£ç†å…³é—­ã€‚</p></li><li><p>é‡æ–°åˆ›å»ºé›†ç¾¤ï¼Œä½¿ç”¨<code>workNode:NodePort</code><strong>å¯ä»¥</strong>è®¿é—®ã€‚</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>kubelabs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
      <tag>kind</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
